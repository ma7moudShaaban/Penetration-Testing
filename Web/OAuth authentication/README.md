# OAuth authentication
- [Overview](#overview)
- [Common Grant Types](#common-grant-types)
- [Stealing Access Tokens](#stealing-access-tokens)
- [Improper CSRF Protection](#improper-csrf-protection)
- [Additional OAuth Vulnerabilities](#additional-oauth-vulnerabilities)



## Overview
- OAuth is a standard that enables secure authorization between services. As such, OAuth is commonly used in Single Sign-On (SSO) scenarios, enabling users to log in to a single service to access multiple different services.
- OAuth achieves this without sharing the user's credentials between services.
- **OAuth Entities**
    - The OAuth protocol comprises the following acting entities:

        - The Resource Owner: The entity that owns the resource. This is typically the user
        - The Client: The service requesting access to the resource on behalf of the resource owner
        - The Authorization Server: The server that authenticates the resource owner and issues access tokens to the client
        - The Resource Server: The server hosting the resources the client requests to access

        ![OAuth1](/images/OAuth%20Flow.jpg)


## Common Grant Types
1. **Authorization Code grant**
- ![Authorization Code Grant](/images/Authorization%20code%20grant.jpg)
    1. Authorization Request
        - This grant type starts with the authorization request from the client academy.htb to the authorization server hubgit.htb:
        ```http
        GET /auth?client_id=1337&redirect_uri=http://academy.htb/callback&response_type=code&scope=user&state=a45c12e87d4522 HTTP/1.1 
        Host: hubgit.htb
        ```
        - This request contains multiple interesting GET parameters:

            - `client_id`: A unique identifier for the client academy.htb
            - `redirect_uri`: The URL to which the browser will be redirected after a successful authorization by the resource owner
            - `response_type`: This is always set to code for the authorization code grant
            - `scope`: This indicates what resources the client academy.htb needs to access. This parameter is optional
            - `state`: A random nonce generated by the client that serves a similar purpose to a CSRF token tying the authorization request to the following callback request. This parameter is optional

    2. Resource Owner Authentication
        - The authorization server hubgit.htb will request the user to log in and authorize the client academy.htb to access the requested resources.
    3. Authorization Code Grant
        - The authorization server redirects the browser to the URL specified in the redirect_uri parameter of the authorization request:
        ```http
        GET /callback?code=ptsmyq2zxyvv23bl&state=a45c12e87d4522 HTTP/1.1
        Host: academy.htb
        ```
        - This request contains two parameters:
            - `code`: The authorization code issued by the authorization server
            - `state`: The state value from the authorization request to tie these two requests together

    4. Access Token Request
        - After obtaining the authorization code, the client requests an access token from the authorization server:
        ```http
        POST /token HTTP/1.1
        Host: hubgit.htb

        client_id=1337&client_secret=SECRET&redirect_uri=http://academy.htb/callback&grant_type=authorization_code&code=ptsmyq2zxyvv23bl
        ```
        - In addition to the previously discussed parameters, this request contains two new parameters:

            - `client_secret`: A secret value assigned to the client by the authorization server during the initial registration. This value authenticates the client to the authorization server
            - `grant_type`: This is always set to authorization_code for the authorization code grant
    5. Access Token Grant
        - The authorization server validates the authorization code and issues a valid access token for the resource server in response to the token request:
        ```json
        {
        "access_token":"RsT5OjbzRn430zqMLgV3Ia",
        "expires_in":3600
        }
        ```
    6. Resource Request
        - The client now holds a valid access token for the resource server and can use this access token to request the resource owner's information:
        ```http
        GET /user_info HTTP/1.1
        Host: hubgit.htb
        Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia
        ```

    7. Resource Response
        - The resource server validates the access token and responds with the resource owner's information:
        ```json
        {username: "john", email: "john@gmail.com", id: 1337}
        ```

> [!NOTE]
> The access token request and access token grant, the resource request and resource response are server-to-server communication.

2. **Implicit Grant**
- ![Implicit Grant](/images/Implicit%20grant.jpg)
    1. Authorization Request
        - The implicit grant type starts with a slightly different authorization request compared to the authorization code grant type:
        ```http
        GET /auth?client_id=1337&redirect_uri=http://academy.htb/callback&response_type=token&scope=user&state=a45c12e87d4522 HTTP/1.1 
        Host: hubgit.htb
        ```
        - The response_type parameter is set to token. All other parameters retain the same meaning.

    2. Resource Owner Authentication
        - The authorization server hubgit.htb will request the user to log in and authorize the client academy.htb to access the requested resources. This is the same as in the authorization code grant.

    3. Access Token Grant
        - This step is the main difference from the authorization token grant. Like before, the authorization server redirects the browser to the URL specified in the authorization request's `redirect_uri` parameter.
        - However, instead of providing an authorization code, this redirect already contains the access token in a URL fragment where it can be extracted using suitable client-side JavaScript code:
        ```
        GET /callback#access_token=RsT5OjbzRn430zqMLgV3Ia&token_type=Bearer&expires_in=3600&scope=user&state=a45c12e87d4522 HTTP/1.1
        Host: academy.htb
        ```
    4. Resource Request
        - The client now holds a valid access token for the resource server and can use this access token to request the resource owner's information. This is the same as in the authorization code grant.
        ```http
        GET /user_info HTTP/1.1
        Host: hubgit.htb
        Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia
        ```
    5. Resource Response
        The resource server validates the access token and responds with the resource owner's information. This is the same as in the authorization code grant.
        ```json
        {username: "john", email: "john@gmail.com", id: 1337}
        ```


## Stealing Access Tokens

- This attack steals user access tokens by exploiting weak `redirect_uri` validation on the Authorization Server.How it works:

    1. Attacker crafts malicious link: Creates an OAuth authorization request with a `redirect_uri` pointing to their server.
    2. Attacker lures victim: Tricks the victim into clicking the link.
    3. Victim grants permission: Victim authenticates with the legitimate Authorization Server.
    4. Authorization Server redirects to attacker: Due to poor validation, the Authorization Server sends the authorization_code to the attacker's server.
    5. Attacker exchanges code for token: The attacker's server uses the code to get an access_token from the Authorization Server.
    6. Access token stolen: Attacker now has the victim's access token and can impersonate them.


## Improper CSRF Protection
- This attack tricks a victim into logging into an attacker's account. 
- This vulnerability exists because Authentication server and client server don't properly use the state parameter to verify user sessions.
1. Attacker needs to obtain an authorization code for their own account:
```http
POST /authorization/signin HTTP/1.1
Host: hubgit.htb
Content-Length: 96
Content-Type: application/x-www-form-urlencoded

username=attacker&password=attacker&client_id=0e8f12335b0bf225&redirect_uri=%2Fclient%2Fcallback
```
2. The response contains a valid authorization code tied to the attacker's account .The attacker can now craft the URL for the authorization code grant using the obtained authorization code:
```http
http://hubgit.htb/client/callback?code=Z0FBQUFBQm1BekxRVGFLdTk5WHZycU9zZ0dCS2IzaWwzWTkxME9tVHJPbXpibTVLV0g0MVRyUVhCSF9vVHVNSHdXX0NZV2FzTHEzTzRFLW5wejU5ai1ONVdxMlc0LU0wMDdURXVPRGYtX05Mb21mZTljTUtzTWwxa1pvdktUVzlWcXJFNzMtZGJ1eWtKcllFQy0xd3RlM3JXUzczUEUtU3lnPT0
```
## Additional OAuth Vulnerabilities
1. **Reflected XSS**

- If we take a look at the authorization request , we can see that there are three parameters from our request that may be reflect as hidden values in the response:

![OAuth xss1](/images/oauth_xss_1.jpg)

- If the web application does not properly sanitize these values, they may lead to reflected XSS. We can test these values by injecting a simple alert proof of concept payload:

![OAuth xss2](/images/oauth_xss_2.jpg)

2. **Open Redirect Chaining**
- This attack works when the legitimate application's website has an "Open Redirect" vulnerability, even if the OAuth server properly validates the main redirect URL.

- Problem Prevention (Usually):

    - OAuth servers prevent code theft by whitelisting redirect_uris.
    - They only allow the authorization_code to be sent back to approved domains. This checks the start of the URL.


- How the Attacker Combines Them:

    1. Attacker Crafts Malicious Link: The attacker creates an OAuth authorization request where the redirect_uri points to the legitimate app's Open Redirect, and that Open Redirect points to the attacker's server.
    ```http
    http://hubgit.htb/auth?client_id=...&redirect_uri=http://academy.htb/redirect?u=http://attacker.htb/callback
    ```
    2. Validation Passes: hubgit.htb (the OAuth server) checks http://academy.htb/ and says "Okay, that's whitelisted!"

    3. Victim Authorizes: The user logs in and approves the request on hubgit.htb.

    4. Code Sent to Open Redirect: hubgit.htb sends the authorization_code to http://academy.htb/redirect.

    5. Open Redirect Passes Code to Attacker: academy.htb/redirect then automatically redirects the user's browser (and the authorization_code) to http://attacker.htb/callback.

    6. Code Stolen: The attacker's server (attacker.htb) now receives the authorization_code.

3. **Malicious Client Impersonation**
- This attack happens when an attacker creates their own fake app (a "malicious client") and a legitimate app fails to properly check who an access token was meant for.

- Attacker's Setup:

    - The attacker creates their own website/app (e.g., evil.htb).

    - They register evil.htb as an official "OAuth client" with a big service like hubgit.htb (the Authorization Server). hubgit.htb doesn't know evil.htb is malicious, only that it's a registered app.

- Victim's Interaction (Unknowing):

    - The attacker tricks a victim into using their hubgit.htb account to "Log in with OAuth" on the attacker's fake app, evil.htb.

    - The victim approves this login on hubgit.htb.

    - hubgit.htb (the Authorization Server) then correctly gives evil.htb (the attacker's app) an access token for the victim's hubgit.htb account. The token is valid and legitimately issued to evil.htb.

- The Crucial Flaw (in Another App):

    - Now, the attacker has a valid access token for the victim's hubgit.htb account, issued for evil.htb.

    - The attacker then tries to use this same access token to access another legitimate app that also uses hubgit.htb for login (e.g., academy.htb).

    - The vulnerability: If academy.htb (the other legitimate app) is poorly implemented and doesn't check if the access token was actually issued to it (academy.htb) or to some other client (evil.htb), it will simply accept the token.

## Resources
- [Hidden OAuth attack vectors](https://portswigger.net/research/hidden-oauth-attack-vectors)