# OAuth authentication
- [Overview](#overview)
- [Common Grant Types](#common-grant-types)
- [Stealing Access Tokens](#stealing-access-tokens)
- [Improper CSRF Protection](#improper-csrf-protection)



## Overview
- OAuth is a standard that enables secure authorization between services. As such, OAuth is commonly used in Single Sign-On (SSO) scenarios, enabling users to log in to a single service to access multiple different services.
- OAuth achieves this without sharing the user's credentials between services.
- **OAuth Entities**
    - The OAuth protocol comprises the following acting entities:

        - The Resource Owner: The entity that owns the resource. This is typically the user
        - The Client: The service requesting access to the resource on behalf of the resource owner
        - The Authorization Server: The server that authenticates the resource owner and issues access tokens to the client
        - The Resource Server: The server hosting the resources the client requests to access

        ![OAuth1](/images/OAuth%20Flow.jpg)


## Common Grant Types
1. **Authorization Code grant**
- ![Authorization Code Grant](/images/Authorization%20code%20grant.jpg)
    1. Authorization Request
        - This grant type starts with the authorization request from the client academy.htb to the authorization server hubgit.htb:
        ```http
        GET /auth?client_id=1337&redirect_uri=http://academy.htb/callback&response_type=code&scope=user&state=a45c12e87d4522 HTTP/1.1 
        Host: hubgit.htb
        ```
        - This request contains multiple interesting GET parameters:

            - `client_id`: A unique identifier for the client academy.htb
            - `redirect_uri`: The URL to which the browser will be redirected after a successful authorization by the resource owner
            - `response_type`: This is always set to code for the authorization code grant
            - `scope`: This indicates what resources the client academy.htb needs to access. This parameter is optional
            - `state`: A random nonce generated by the client that serves a similar purpose to a CSRF token tying the authorization request to the following callback request. This parameter is optional

    2. Resource Owner Authentication
        - The authorization server hubgit.htb will request the user to log in and authorize the client academy.htb to access the requested resources.
    3. Authorization Code Grant
        - The authorization server redirects the browser to the URL specified in the redirect_uri parameter of the authorization request:
        ```http
        GET /callback?code=ptsmyq2zxyvv23bl&state=a45c12e87d4522 HTTP/1.1
        Host: academy.htb
        ```
        - This request contains two parameters:
            - `code`: The authorization code issued by the authorization server
            - `state`: The state value from the authorization request to tie these two requests together

    4. Access Token Request
        - After obtaining the authorization code, the client requests an access token from the authorization server:
        ```http
        POST /token HTTP/1.1
        Host: hubgit.htb

        client_id=1337&client_secret=SECRET&redirect_uri=http://academy.htb/callback&grant_type=authorization_code&code=ptsmyq2zxyvv23bl
        ```
        - In addition to the previously discussed parameters, this request contains two new parameters:

            - `client_secret`: A secret value assigned to the client by the authorization server during the initial registration. This value authenticates the client to the authorization server
            - `grant_type`: This is always set to authorization_code for the authorization code grant
    5. Access Token Grant
        - The authorization server validates the authorization code and issues a valid access token for the resource server in response to the token request:
        ```json
        {
        "access_token":"RsT5OjbzRn430zqMLgV3Ia",
        "expires_in":3600
        }
        ```
    6. Resource Request
        - The client now holds a valid access token for the resource server and can use this access token to request the resource owner's information:
        ```http
        GET /user_info HTTP/1.1
        Host: hubgit.htb
        Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia
        ```

    7. Resource Response
        - The resource server validates the access token and responds with the resource owner's information:
        ```json
        {username: "john", email: "john@gmail.com", id: 1337}
        ```

> [!NOTE]
> The access token request and access token grant, the resource request and resource response are server-to-server communication.

2. **Implicit Grant**
- ![Implicit Grant](/images/Implicit%20grant.jpg)
    1. Authorization Request
        - The implicit grant type starts with a slightly different authorization request compared to the authorization code grant type:
        ```http
        GET /auth?client_id=1337&redirect_uri=http://academy.htb/callback&response_type=token&scope=user&state=a45c12e87d4522 HTTP/1.1 
        Host: hubgit.htb
        ```
        - The response_type parameter is set to token. All other parameters retain the same meaning.

    2. Resource Owner Authentication
        - The authorization server hubgit.htb will request the user to log in and authorize the client academy.htb to access the requested resources. This is the same as in the authorization code grant.

    3. Access Token Grant
        - This step is the main difference from the authorization token grant. Like before, the authorization server redirects the browser to the URL specified in the authorization request's `redirect_uri` parameter.
        - However, instead of providing an authorization code, this redirect already contains the access token in a URL fragment where it can be extracted using suitable client-side JavaScript code:
        ```
        GET /callback#access_token=RsT5OjbzRn430zqMLgV3Ia&token_type=Bearer&expires_in=3600&scope=user&state=a45c12e87d4522 HTTP/1.1
        Host: academy.htb
        ```
    4. Resource Request
        - The client now holds a valid access token for the resource server and can use this access token to request the resource owner's information. This is the same as in the authorization code grant.
        ```http
        GET /user_info HTTP/1.1
        Host: hubgit.htb
        Authorization: Bearer RsT5OjbzRn430zqMLgV3Ia
        ```
    5. Resource Response
        The resource server validates the access token and responds with the resource owner's information. This is the same as in the authorization code grant.
        ```json
        {username: "john", email: "john@gmail.com", id: 1337}
        ```


## Stealing Access Tokens

- This attack steals user access tokens by exploiting weak redirect_uri validation on the Authorization Server.How it works:

    1. Attacker crafts malicious link: Creates an OAuth authorization request with a redirect_uri pointing to their server.
    2. Attacker lures victim: Tricks the victim into clicking the link.
    3. Victim grants permission: Victim authenticates with the legitimate Authorization Server.
    4. Authorization Server redirects to attacker: Due to poor validation, the Authorization Server sends the authorization_code to the attacker's server.
    5. Attacker exchanges code for token: The attacker's server uses the code to get an access_token from the Authorization Server.
    6. Access token stolen: Attacker now has the victim's access token and can impersonate them.


## Improper CSRF Protection
- This attack tricks a victim into logging into an attacker's account. 
- This vulnerability exists because Authentication server and client server don't properly use the state parameter to verify user sessions.
1. Attacker needs to obtain an authorization code for their own account:
```http
POST /authorization/signin HTTP/1.1
Host: hubgit.htb
Content-Length: 96
Content-Type: application/x-www-form-urlencoded

username=attacker&password=attacker&client_id=0e8f12335b0bf225&redirect_uri=%2Fclient%2Fcallback
```
2. The response contains a valid authorization code tied to the attacker's account .The attacker can now craft the URL for the authorization code grant using the obtained authorization code:
```http
http://hubgit.htb/client/callback?code=Z0FBQUFBQm1BekxRVGFLdTk5WHZycU9zZ0dCS2IzaWwzWTkxME9tVHJPbXpibTVLV0g0MVRyUVhCSF9vVHVNSHdXX0NZV2FzTHEzTzRFLW5wejU5ai1ONVdxMlc0LU0wMDdURXVPRGYtX05Mb21mZTljTUtzTWwxa1pvdktUVzlWcXJFNzMtZGJ1eWtKcllFQy0xd3RlM3JXUzczUEUtU3lnPT0
```



## Resources
- [Hidden OAuth attack vectors](https://portswigger.net/research/hidden-oauth-attack-vectors)