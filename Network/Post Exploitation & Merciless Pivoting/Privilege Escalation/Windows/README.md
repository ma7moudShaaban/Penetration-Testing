# Windows Privilege Escalation
- [Situational Awareness](#situational-awareness)
- [Initial Enumeration](#initial-enumeration)
    - [System Information](#system-information)
    - [User & Group Information](#user--group-information)
- [Communication with Processes](#communication-with-processes)
- [Windows User Privileges](../Windows/Windows%20Privileges/README.md)
- [Windows Group Privileges](../Windows/Windows%20Privileges/README.md)







## Situational Awareness
- **Network Information**
```bat
# Interface(s), IP Address(es), DNS Information
C:\htb> ipconfig /all

# ARP Table
C:\htb> arp -a

# Routing Table
C:\htb> route print

```

- **Enumerating Protections**
```powershell
# Check Windows Defender Status
PS C:\htb> Get-MpComputerStatus

# List AppLocker Rules
PS C:\htb> Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

# Test AppLocker Policy
PS C:\htb> Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone

FilePath                    PolicyDecision MatchingRule
--------                    -------------- ------------
C:\Windows\System32\cmd.exe         Denied c:\windows\system32\cmd.exe


```
## Initial Enumeration
### System Information
```bat
# Tasklist
C:\htb> tasklist /svc

# Display All Environment Variables
C:\htb> set

# View Detailed Configuration Information
C:\htb> systeminfo

```
- **Patches and Updates**
    - If systeminfo doesn't display hotfixes, they may be queriable with WMI using the WMI-Command binary with QFE (Quick Fix Engineering) to display patches.

```bat
C:\htb> wmic qfe

Caption                                     CSName        Description      FixComments  HotFixID   InstallDate  InstalledBy          InstalledOn  Name  ServicePackInEffect  Status
http://support.microsoft.com/?kbid=3199986  WINLPE-SRV01  Update                        KB3199986               NT AUTHORITY\SYSTEM  11/21/2016
https://support.microsoft.com/help/5001078  WINLPE-SRV01  Security Update               KB5001078               NT AUTHORITY\SYSTEM  3/25/2021
http://support.microsoft.com/?kbid=4103723  WINLPE-SRV01  Security Update               KB4103723               NT AUTHORITY\SYSTEM  3/25/2021
```
```powershell
PS C:\htb> Get-HotFix | ft -AutoSize

Source       Description     HotFixID  InstalledBy                InstalledOn
------       -----------     --------  -----------                -----------
WINLPE-SRV01 Update          KB3199986 NT AUTHORITY\SYSTEM        11/21/2016 12:00:00 AM
WINLPE-SRV01 Update          KB4054590 WINLPE-SRV01\Administrator 3/30/2021 12:00:00 AM
WINLPE-SRV01 Security Update KB5001078 NT AUTHORITY\SYSTEM        3/25/2021 12:00:00 AM
WINLPE-SRV01 Security Update KB3200970 WINLPE-SRV01\Administrator 4/13/2021 12:00:00 AM
```

- **Installed programs**

```bat
C:\htb> wmic product get name
```
```powershell
PS C:\htb> Get-WmiObject -Class Win32_Product |  select Name, Version
```

- **Display Running Processes**
```bat
# Netstat
PS C:\htb> netstat -ano
```

### User & Group Information

```bat
# Logged-In Users
C:\htb> query user

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>administrator         rdp-tcp#2           1  Active          .  3/25/2021 9:27 AM

# Current User
C:\htb> echo %USERNAME%

htb-student 

# Current User Privileges
C:\htb> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled

# Current User Group Information
C:\htb> whoami /groups

# Get All Users
C:\htb> net user

# Get All Groups
C:\htb> net localgroup

# Details About a Group
C:\htb> net localgroup administrators

# Get Password Policy & Other Account Information
C:\htb> net accounts
```


## Communication with Processes
- **Access Token**
    - In Windows, access tokens are used to describe the security context (security attributes or rules) of a process or thread.
    - The token includes information about the user account's identity and privileges related to a specific process or thread.
    - When a user authenticates to a system, their password is verified against a security database, and if properly authenticated, they will be assigned an access token.
    - Every time a user interacts with a process, a copy of this token will be presented to determine their privilege level.


- **Enumerating Network Services**
    ```bat
    # Display Active Network Connections
    C:\htb> netstat -ano
    ```
    - Examples:
        1. Splunk 
            - One of the best examples of this type of privilege escalation is the Splunk Universal Forwarder, installed on endpoints to send logs into Splunk. 
            - The default configuration of Splunk did not have any authentication on the software and allowed anyone to deploy applications, which could lead to code execution. 
            - Again, the default configuration of Splunk was to run it as SYSTEM$ and not a low privilege user.
            - Check out [Splunk Universal Forwarder Hijacking](https://airman604.medium.com/splunk-universal-forwarder-hijacking-5899c3e0e6b2) and [SplunkWhisperer2](https://clement.notin.org/blog/2019/02/25/Splunk-Universal-Forwarder-Hijacking-2-SplunkWhisperer2/).

        2. Erlang
            - Another overlooked but common local privilege escalation vector is the Erlang Port (25672). 
            - Erlang is a programming language designed around distributed computing and will have a network port that allows other Erlang nodes to join the cluster. 
            - The secret to join this cluster is called a cookie. 
            - Many applications that utilize Erlang will either use a weak cookie (RabbitMQ uses rabbit by default) or place the cookie in a configuration file that is not well protected. 

- **Named Pipes**
    - Named pipes are like chat rooms for programs on the same computer. They let two programs talk to each other by sending and receiving messages.

    - **Key Points:**
    1. What's a Pipe?
        - A pipe is like a tube where one program writes messages, and another reads them.
    2. Named Pipes:

        - A "named pipe" is just a pipe with a name (like \\.\pipe\my_pipe) so programs know where to connect.
    3. How Communication Works:

        - One program creates the pipe (server).
        - Another program connects to it (client) to send or receive messages.
        - They can either:
            - Send data one way (like a one-way street).
            - Send data both ways (like a conversation).
    4. Cobalt Strike Example:

        - Cobalt Strike uses named pipes for safe communication:
            1. It creates a pipe (e.g., \\.\pipe\msagent_12).
            2. Commands run in another program, and results are sent through the pipe.
            3. This keeps the main program safeâ€”if the command crashes, it doesn't affect the main tool.
    5. Why Change Names?

        - Hackers might rename pipes to look like something harmless, like a Chrome-related name (mojo), to avoid detection.
    6. How to Spot Named Pipes:

        - Use tools like [PipeList](https://learn.microsoft.com/en-us/sysinternals/downloads/pipelist) to see which pipes are active and who's using them.

    ```bat
    # Listing Named Pipes with Pipelist
    C:\htb> pipelist.exe /accepteula
    ```
    ```powershell
    # Listing Named Pipes with PowerShell
    PS C:\htb>  gci \\.\pipe\

    ```
    - After obtaining a listing of named pipes, we can use Accesschk to enumerate the permissions assigned to a specific named pipe by reviewing the Discretionary Access List (DACL), which shows us who has the permissions to modify, write, read, or execute a resource.
    ```bat
    # Reviewing LSASS Named Pipe Permissions
    C:\htb> accesschk.exe /accepteula \\.\Pipe\lsass -v

    ```
    
> [!TIP]
> Using accesschk we can search for all named pipes that allow write access with a command such as `accesschk.exe -w \pipe\* -v`



# Resources
- Pre-compiled binaries of Seatbelt and SharpUp [here](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries)
- [Hacktricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation) 
- [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)
- [LOLBAS](https://lolbas-project.github.io/)
