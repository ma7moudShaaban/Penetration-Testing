# Windows Privilege Escalation
- [Situational Awareness](#situational-awareness)
- [Initial Enumeration](#initial-enumeration)
    - [System Information](#system-information)
    - [User & Group Information](#user--group-information)
- [Communication with Processes](#communication-with-processes)
- [Windows User Privileges](#windows-user-privileges)
    - [SeImpersonate and SeAssignPrimaryToken](#seimpersonate-and-seassignprimarytoken)







## Situational Awareness
- **Network Information**
```bat
# Interface(s), IP Address(es), DNS Information
C:\htb> ipconfig /all

# ARP Table
C:\htb> arp -a

# Routing Table
C:\htb> route print

```

- **Enumerating Protections**
```powershell
# Check Windows Defender Status
PS C:\htb> Get-MpComputerStatus

# List AppLocker Rules
PS C:\htb> Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

# Test AppLocker Policy
PS C:\htb> Get-AppLockerPolicy -Local | Test-AppLockerPolicy -path C:\Windows\System32\cmd.exe -User Everyone

FilePath                    PolicyDecision MatchingRule
--------                    -------------- ------------
C:\Windows\System32\cmd.exe         Denied c:\windows\system32\cmd.exe


```
## Initial Enumeration
### System Information
```bat
# Tasklist
C:\htb> tasklist /svc

# Display All Environment Variables
C:\htb> set

# View Detailed Configuration Information
C:\htb> systeminfo

```
- **Patches and Updates**
    - If systeminfo doesn't display hotfixes, they may be queriable with WMI using the WMI-Command binary with QFE (Quick Fix Engineering) to display patches.

```bat
C:\htb> wmic qfe

Caption                                     CSName        Description      FixComments  HotFixID   InstallDate  InstalledBy          InstalledOn  Name  ServicePackInEffect  Status
http://support.microsoft.com/?kbid=3199986  WINLPE-SRV01  Update                        KB3199986               NT AUTHORITY\SYSTEM  11/21/2016
https://support.microsoft.com/help/5001078  WINLPE-SRV01  Security Update               KB5001078               NT AUTHORITY\SYSTEM  3/25/2021
http://support.microsoft.com/?kbid=4103723  WINLPE-SRV01  Security Update               KB4103723               NT AUTHORITY\SYSTEM  3/25/2021
```
```powershell
PS C:\htb> Get-HotFix | ft -AutoSize

Source       Description     HotFixID  InstalledBy                InstalledOn
------       -----------     --------  -----------                -----------
WINLPE-SRV01 Update          KB3199986 NT AUTHORITY\SYSTEM        11/21/2016 12:00:00 AM
WINLPE-SRV01 Update          KB4054590 WINLPE-SRV01\Administrator 3/30/2021 12:00:00 AM
WINLPE-SRV01 Security Update KB5001078 NT AUTHORITY\SYSTEM        3/25/2021 12:00:00 AM
WINLPE-SRV01 Security Update KB3200970 WINLPE-SRV01\Administrator 4/13/2021 12:00:00 AM
```

- **Installed programs**

```bat
C:\htb> wmic product get name
```
```powershell
PS C:\htb> Get-WmiObject -Class Win32_Product |  select Name, Version
```

- **Display Running Processes**
```bat
# Netstat
PS C:\htb> netstat -ano
```

### User & Group Information

```bat
# Logged-In Users
C:\htb> query user

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>administrator         rdp-tcp#2           1  Active          .  3/25/2021 9:27 AM

# Current User
C:\htb> echo %USERNAME%

htb-student 

# Current User Privileges
C:\htb> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled

# Current User Group Information
C:\htb> whoami /groups

# Get All Users
C:\htb> net user

# Get All Groups
C:\htb> net localgroup

# Details About a Group
C:\htb> net localgroup administrators

# Get Password Policy & Other Account Information
C:\htb> net accounts
```


## Communication with Processes
- **Access Token**
    - In Windows, access tokens are used to describe the security context (security attributes or rules) of a process or thread.
    - The token includes information about the user account's identity and privileges related to a specific process or thread.
    - When a user authenticates to a system, their password is verified against a security database, and if properly authenticated, they will be assigned an access token.
    - Every time a user interacts with a process, a copy of this token will be presented to determine their privilege level.


- **Enumerating Network Services**
    ```bat
    # Display Active Network Connections
    C:\htb> netstat -ano
    ```
    - Examples:
        1. Splunk 
            - One of the best examples of this type of privilege escalation is the Splunk Universal Forwarder, installed on endpoints to send logs into Splunk. 
            - The default configuration of Splunk did not have any authentication on the software and allowed anyone to deploy applications, which could lead to code execution. 
            - Again, the default configuration of Splunk was to run it as SYSTEM$ and not a low privilege user.
            - Check out [Splunk Universal Forwarder Hijacking](https://airman604.medium.com/splunk-universal-forwarder-hijacking-5899c3e0e6b2) and [SplunkWhisperer2](https://clement.notin.org/blog/2019/02/25/Splunk-Universal-Forwarder-Hijacking-2-SplunkWhisperer2/).

        2. Erlang
            - Another overlooked but common local privilege escalation vector is the Erlang Port (25672). 
            - Erlang is a programming language designed around distributed computing and will have a network port that allows other Erlang nodes to join the cluster. 
            - The secret to join this cluster is called a cookie. 
            - Many applications that utilize Erlang will either use a weak cookie (RabbitMQ uses rabbit by default) or place the cookie in a configuration file that is not well protected. 

- **Named Pipes**
    - Named pipes are like chat rooms for programs on the same computer. They let two programs talk to each other by sending and receiving messages.

    - **Key Points:**
    1. What's a Pipe?
        - A pipe is like a tube where one program writes messages, and another reads them.
    2. Named Pipes:

        - A "named pipe" is just a pipe with a name (like \\.\pipe\my_pipe) so programs know where to connect.
    3. How Communication Works:

        - One program creates the pipe (server).
        - Another program connects to it (client) to send or receive messages.
        - They can either:
            - Send data one way (like a one-way street).
            - Send data both ways (like a conversation).
    4. Cobalt Strike Example:

        - Cobalt Strike uses named pipes for safe communication:
            1. It creates a pipe (e.g., \\.\pipe\msagent_12).
            2. Commands run in another program, and results are sent through the pipe.
            3. This keeps the main program safeâ€”if the command crashes, it doesn't affect the main tool.
    5. Why Change Names?

        - Hackers might rename pipes to look like something harmless, like a Chrome-related name (mojo), to avoid detection.
    6. How to Spot Named Pipes:

        - Use tools like [PipeList](https://learn.microsoft.com/en-us/sysinternals/downloads/pipelist) to see which pipes are active and who's using them.

    ```bat
    # Listing Named Pipes with Pipelist
    C:\htb> pipelist.exe /accepteula
    ```
    ```powershell
    # Listing Named Pipes with PowerShell
    PS C:\htb>  gci \\.\pipe\

    ```
    - After obtaining a listing of named pipes, we can use Accesschk to enumerate the permissions assigned to a specific named pipe by reviewing the Discretionary Access List (DACL), which shows us who has the permissions to modify, write, read, or execute a resource.
    ```bat
    # Reviewing LSASS Named Pipe Permissions
    C:\htb> accesschk.exe /accepteula \\.\Pipe\lsass -v

    ```
    
> [!TIP]
> Using accesschk we can search for all named pipes that allow write access with a command such as `accesschk.exe -w \pipe\* -v`

## Windows User Privileges
- **Windows Privileges Overview**
- Privileges in Windows are rights that an account can be granted to perform a variety of operations on the local system.
- Privileges are different from access rights, which a system uses to grant or deny access to securable objects. 
- User and group privileges are stored in a database and granted via an access token when a user logs on to a system.
- Each time a user attempts to perform a privileged action, the system reviews the user's access token to see if the account has the required privileges, and if so, checks to see if they are enabled.

- **Windows Authorization Process**
- Security principals are anything that can be authenticated by the Windows operating system, including user and computer accounts, processes that run in the security context or another user/computer account, or the security groups that these accounts belong to.
- Security principals are the primary way of controlling access to resources on Windows hosts.
- Every single security principal is identified by a unique Security Identifier (SID). When a security principal is created, it is assigned a SID which remains assigned to that principal for its lifetime.
![auth_proc](/images/auth_process.jpg)

- **Rights and Privileges in Windows**
- Windows contains many groups that grant their members powerful rights and privileges. Many of these can be abused to escalate privileges on both a standalone Windows host and within an Active Directory domain environment.Some of these groups are listed below:

|Group	| Description  | 
|:------|:-------------|
|Default Administrators|	Domain Admins and Enterprise Admins are "super" groups.|
|Server Operators|	Members can modify services, access SMB shares, and backup files.|
|Backup Operators|	Members are allowed to log onto DCs locally and should be considered Domain Admins. They can make shadow copies of the SAM/NTDS database, read the registry remotely, and access the file system on the DC via SMB. This group is sometimes added to the local Backup Operators group on non-DCs.|
|Print Operators|	Members can log on to DCs locally and "trick" Windows into loading a malicious driver.|
|Hyper-V Administrators|	If there are virtual DCs, any virtualization admins, such as members of Hyper-V Administrators, should be considered Domain Admins.|
|Account Operators|	Members can modify non-protected accounts and groups in the domain.|
|Remote Desktop Users|	Members are not given any useful permissions by default but are often granted additional rights such as Allow Login Through Remote Desktop Services and can move laterally using the RDP protocol.|
|Remote Management Users|	Members can log on to DCs with PSRemoting (This group is sometimes added to the local remote management group on non-DCs).|
|Group Policy Creator Owners|	Members can create new GPOs but would need to be delegated additional permissions to link GPOs to a container such as a domain or OU.|
|Schema Admins|	Members can modify the Active Directory schema structure and backdoor any to-be-created Group/GPO by adding a compromised account to the default object ACL.|
|DNS Admins|	Members can load a DLL on a DC, but do not have the necessary permissions to restart the DNS server. They can load a malicious DLL and wait for a reboot as a persistence mechanism. Loading a DLL will often result in the service crashing. A more reliable way to exploit this group is to create a WPAD record.|

- **User Rights Assignment**
- Depending on group membership, and other factors such as privileges assigned via domain and local Group Policy, users can have various rights assigned to their account.
- This Microsoft article on [User Rights Assignment](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/security-policy-settings/user-rights-assignment) provides a detailed explanation of each of the user rights that can be set in Windows as well as security considerations applicable to each right.

- Typing the command `whoami /priv` will give you a listing of all user rights assigned to your current user.
- When a privilege is listed for our account in the Disabled state, it means that our account has the specific privilege assigned. Still, it cannot be used in an access token to perform the associated actions until it is enabled.
- Windows does not provide a built-in command or PowerShell cmdlet to enable privileges, so we need some scripting to help us out.
- We will see ways to abuse various privileges throughout this module and various ways to enable specific privileges within our current process.
- One example is this [PowerShell script](https://www.powershellgallery.com/packages/PoshPrivilege/0.3.0.0/Content/Scripts%5CEnable-Privilege.ps1) which can be used to enable certain privileges, or this [script](https://www.leeholmes.com/adjusting-token-privileges-in-powershell/) which can be used to adjust token privileges.

### SeImpersonate and SeAssignPrimaryToken



# Resources
- Pre-compiled binaries of Seatbelt and SharpUp [here](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries)
- [Hacktricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation) 
- [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)
- [LOLBAS](https://lolbas-project.github.io/)
